# REPLIT AGENT SPECIFICATION: QR Code Setup Flow with Pre-Population & One-Time Use

**Feature:** Complete QR Code Activation Flow  
**Priority:** CRITICAL (Core Business Logic)  
**Estimated Time:** 3-4 hours  
**Complexity:** MEDIUM  
**Files to Modify:** 4 files

---

## 1. OBJECTIVE

Implement complete QR code activation flow where:
1. âœ… QR code redirects to **new site** (not old site)
2. âœ… Setup page opens with **pre-populated customer data** (editable)
3. âœ… User completes and submits form
4. âœ… System creates household record
5. âœ… QR code is **marked as used** (one-time use only)
6. âœ… Subsequent scans show "Already activated" message

---

## 2. CURRENT PROBLEM (From Screenshot)

### Issue 1: Wrong Redirect URL
**Current:** QR code points to old site  
**Should be:** QR code points to new site setup page

### Issue 2: No Pre-Population
**Current:** Setup form is empty  
**Should be:** Customer data from order pre-fills form

### Issue 3: No One-Time Use Enforcement
**Current:** QR code can be used multiple times  
**Should be:** QR code disabled after first successful activation

---

## 3. IMPLEMENTATION OVERVIEW

### Files to Modify:
1. âœ… `server/routes.ts` - QR code generation (change URL)
2. âœ… `server/routes.ts` - Add customer data lookup endpoint
3. âœ… `client/src/pages/Onboarding.tsx` - Pre-fill form with customer data
4. âœ… `server/routes.ts` - Mark QR as used after activation

---

## 4. PART 1: FIX QR CODE URL (NEW SITE)

### Current State (WRONG):
```typescript
// In server/routes.ts webhook handler
const setupUrl = `${baseUrl}/setup/${activationCode}`;
// Example: https://old-site.com/setup/OJnpwrlc8PsQ
```

### Required State (CORRECT):
```typescript
// Should point to NEW site
const setupUrl = `${process.env.NEW_SITE_URL || baseUrl}/setup/${activationCode}`;
// Example: https://upkeepqr.com/setup/OJnpwrlc8PsQ
```

### STEP 1A: Add Environment Variable

**File:** `.env`

**Add this line:**
```env
# New site URL for QR codes
NEW_SITE_URL=https://upkeepqr.com
```

**Or if using Replit:**
```env
NEW_SITE_URL=https://your-replit-url.replit.app
```

### STEP 1B: Update QR Code Generation

**File:** `server/routes.ts`

**Find this code (around line 550-600 in webhook handler):**
```typescript
for (let i = 0; i < quantity; i++) {
  const activationCode = nanoid(12);
  const setupUrl = `${baseUrl}/setup/${activationCode}`;  // â† WRONG
  
  // Generate QR code
  const qrCodeBuffer = await QRCode.toBuffer(setupUrl, {...});
}
```

**Replace with:**
```typescript
for (let i = 0; i < quantity; i++) {
  const activationCode = nanoid(12);
  
  // Use NEW_SITE_URL for QR codes (critical!)
  const newSiteUrl = process.env.NEW_SITE_URL || process.env.PUBLIC_BASE_URL || 'http://localhost:5000';
  const setupUrl = `${newSiteUrl}/setup/${activationCode}`;  // â† CORRECT
  
  console.log(`âœ… Generated QR code for: ${setupUrl}`);
  
  // Generate QR code
  const qrCodeBuffer = await QRCode.toBuffer(setupUrl, {
    type: 'png',
    width: 512,
    margin: 2,
    color: {
      dark: '#000000',
      light: '#FFFFFF'
    }
  });
  
  // ... rest of code
}
```

**Critical:** This ensures QR codes point to the NEW site!

---

## 5. PART 2: CUSTOMER DATA LOOKUP ENDPOINT

### Purpose
Allow setup page to fetch customer data by activation code for pre-population.

### STEP 2: Add Customer Data Lookup Endpoint

**File:** `server/routes.ts`

**Location:** Add after other API routes (around line 800-900)

**Add this complete endpoint:**
```typescript
// GET /api/setup/:token/customer-data - Get customer data for pre-population
app.get("/api/setup/:token/customer-data", publicApiLimiter, async (req, res) => {
  await createAuditLog(req, '/api/setup/:token/customer-data');
  
  try {
    const { token } = req.params;
    
    console.log(`ğŸ“‹ Looking up customer data for token: ${token}`);
    
    // Look up order item by activation code
    const orderItem = await storage.getOrderItemByActivationCode(token);
    
    if (!orderItem) {
      console.log(`âš ï¸  Token not found: ${token}`);
      // Token not found - return empty data (user will fill manually)
      return res.json({
        found: false,
        prefilled: false,
        data: {},
        message: 'Token not found. Please fill in your information manually.'
      });
    }
    
    const { item, order } = orderItem;
    
    // Check if QR code already used (one-time use enforcement)
    if (item.activationStatus === 'activated') {
      console.log(`âŒ Token already activated: ${token}`);
      return res.status(409).json({
        found: true,
        prefilled: false,
        alreadyActivated: true,
        activatedAt: item.activatedAt,
        activatedByEmail: item.activatedByEmail,
        message: 'This QR code has already been activated and cannot be used again.',
        data: {}
      });
    }
    
    // Return customer data for pre-fill
    console.log(`âœ… Found customer data for: ${order.customerEmail}`);
    
    res.json({
      found: true,
      prefilled: true,
      alreadyActivated: false,
      data: {
        fullName: order.customerName,
        email: order.customerEmail,
        phone: order.customerPhone,
        streetAddress: order.shipAddressLine1,
        addressLine2: order.shipAddressLine2 || '',
        city: order.shipCity,
        state: order.shipState,
        postalCode: order.shipZip,
        country: order.shipCountry || 'US',
      },
      itemId: item.id,
      orderId: order.id,
      activationCode: token
    });
    
  } catch (error: any) {
    console.error('Error fetching customer data:', error);
    return handleError(error, 'setup/customer-data lookup', res);
  }
});
```

### STEP 2B: Add Storage Function for Lookup

**File:** `server/storage.ts`

**Location:** Add after other storage functions

**Add this function:**
```typescript
/**
 * Get order item and associated order by activation code
 * Used for customer data lookup and one-time use enforcement
 */
export async function getOrderItemByActivationCode(activationCode: string): Promise<{
  item: OrderMagnetItem;
  order: OrderMagnetOrder;
} | null> {
  try {
    // Import from db module
    const { db } = await import('./db');
    const { orderMagnetItemsTable, orderMagnetOrdersTable } = await import('../shared/schema');
    const { eq } = await import('drizzle-orm');
    
    console.log(`ğŸ” Searching for activation code: ${activationCode}`);
    
    // Find item by activation code
    const items = await db
      .select()
      .from(orderMagnetItemsTable)
      .where(eq(orderMagnetItemsTable.activationCode, activationCode))
      .limit(1);
    
    if (!items || items.length === 0) {
      console.log(`âŒ No item found for code: ${activationCode}`);
      return null;
    }
    
    const item = items[0];
    console.log(`âœ… Found item: ${item.id} for order: ${item.orderId}`);
    
    // Get associated order for customer details
    const orders = await db
      .select()
      .from(orderMagnetOrdersTable)
      .where(eq(orderMagnetOrdersTable.id, item.orderId))
      .limit(1);
    
    if (!orders || orders.length === 0) {
      console.log(`âŒ No order found for item: ${item.id}`);
      return null;
    }
    
    const order = orders[0];
    console.log(`âœ… Found order: ${order.id} for customer: ${order.customerEmail}`);
    
    return {
      item,
      order
    };
    
  } catch (error) {
    console.error('Error fetching order item by activation code:', error);
    return null;
  }
}
```

---

## 6. PART 3: PRE-POPULATE SETUP FORM

### Purpose
Fetch customer data when page loads and pre-fill form fields (editable).

### STEP 3: Update Onboarding Component

**File:** `client/src/pages/Onboarding.tsx`

**Location:** Update the component to fetch and pre-fill customer data

### STEP 3A: Add State for Customer Data

**Find this section (around line 20-40):**
```typescript
const [formData, setFormData] = useState({
  fullName: '',
  phone: '',
  email: '',
  // ... other fields
});
```

**Add these new state variables AFTER formData:**
```typescript
const [customerDataLoaded, setCustomerDataLoaded] = useState(false);
const [customerDataError, setCustomerDataError] = useState('');
const [qrAlreadyActivated, setQrAlreadyActivated] = useState(false);
```

### STEP 3B: Add useEffect to Fetch Customer Data

**Find the existing useEffect (if any) OR add this new one:**

**Location:** Add after all useState declarations, before the JSX return

```typescript
// Fetch customer data on component mount
useEffect(() => {
  const fetchCustomerData = async () => {
    if (!token) {
      console.log('No token provided');
      return;
    }
    
    try {
      console.log(`ğŸ” Fetching customer data for token: ${token}`);
      
      const API_BASE_URL = import.meta.env.VITE_API_URL || '';
      const response = await fetch(`${API_BASE_URL}/api/setup/${token}/customer-data`);
      
      if (!response.ok) {
        if (response.status === 409) {
          // QR code already activated
          const data = await response.json();
          setQrAlreadyActivated(true);
          setCustomerDataError(data.message || 'This QR code has already been activated.');
          
          // Show toast notification
          toast({
            variant: "destructive",
            title: "âŒ Already Activated",
            description: data.message,
          });
          
          return;
        }
        
        throw new Error('Failed to fetch customer data');
      }
      
      const result = await response.json();
      
      if (result.alreadyActivated) {
        // Handle already activated state
        setQrAlreadyActivated(true);
        setCustomerDataError(result.message);
        
        toast({
          variant: "destructive",
          title: "âŒ Already Activated",
          description: result.message,
        });
        
        return;
      }
      
      if (result.prefilled && result.data) {
        // Pre-fill form with customer data
        console.log('âœ… Pre-filling form with customer data');
        
        setFormData(prev => ({
          ...prev,
          fullName: result.data.fullName || prev.fullName,
          email: result.data.email || prev.email,
          phone: result.data.phone || prev.phone,
          streetAddress: result.data.streetAddress || prev.streetAddress,
          city: result.data.city || prev.city,
          state: result.data.state || prev.state,
          postalCode: result.data.postalCode || prev.postalCode,
          country: result.data.country || prev.country,
        }));
        
        setCustomerDataLoaded(true);
        
        // Show success notification
        toast({
          title: "âœ… Welcome back!",
          description: "We've pre-filled your information. Please review and complete the form.",
        });
      } else {
        console.log('â„¹ï¸  No customer data found - user will fill manually');
      }
      
    } catch (error) {
      console.error('Error fetching customer data:', error);
      // Fail silently - user can still fill form manually
      setCustomerDataError('Could not load your information. Please fill in the form manually.');
    }
  };
  
  fetchCustomerData();
}, [token]); // Run when token changes
```

### STEP 3C: Add Already Activated UI

**Find the return statement with JSX:**

**Add this BEFORE the main form (right after opening <div>):**

```typescript
return (
  <div className="min-h-screen bg-background pt-16">
    <div className="max-w-2xl mx-auto p-6">
      
      {/* Already Activated Warning - NEW */}
      {qrAlreadyActivated && (
        <div className="mb-6 p-6 bg-destructive/10 border-2 border-destructive rounded-lg">
          <div className="flex items-start gap-3">
            <div className="text-3xl">ğŸ”’</div>
            <div className="flex-1">
              <h2 className="text-xl font-bold text-destructive mb-2">
                QR Code Already Activated
              </h2>
              <p className="text-muted-foreground mb-4">
                {customerDataError}
              </p>
              <p className="text-sm text-muted-foreground">
                Each QR code can only be activated once for security reasons. 
                If you need assistance, please contact support at{' '}
                <a href="mailto:support@upkeepqr.com" className="text-primary underline">
                  support@upkeepqr.com
                </a>
              </p>
            </div>
          </div>
        </div>
      )}
      
      {/* Original form continues here */}
      <Card className={qrAlreadyActivated ? 'opacity-50 pointer-events-none' : ''}>
        {/* ... existing form code ... */}
      </Card>
    </div>
  </div>
);
```

### STEP 3D: Disable Form if Already Activated

**Find the form submit button:**

```typescript
<Button 
  type="submit" 
  disabled={loading}  // â† OLD
>
  Complete Setup
</Button>
```

**Change to:**

```typescript
<Button 
  type="submit" 
  disabled={loading || qrAlreadyActivated}  // â† NEW: Disable if already activated
  className={qrAlreadyActivated ? 'cursor-not-allowed opacity-50' : ''}
>
  {qrAlreadyActivated ? 'ğŸ”’ Already Activated' : 'Complete Setup'}
</Button>
```

---

## 7. PART 4: MARK QR CODE AS USED AFTER ACTIVATION

### Purpose
Update activation status after successful form submission (one-time use).

### STEP 4: Update Activation Endpoint

**File:** `server/routes.ts`

**Find the POST /api/setup/activate endpoint (around line 200-400):**

**Current code:**
```typescript
app.post("/api/setup/activate", publicApiLimiter, async (req, res) => {
  // ... validation ...
  
  // Create household
  household = await storage.createHousehold({...});
  
  // ... rest of code ...
  
  res.json({ success: true, household: {...} });
});
```

**Add this code BEFORE res.json() response:**

```typescript
app.post("/api/setup/activate", publicApiLimiter, async (req, res) => {
  await createAuditLog(req, '/api/setup/activate');
  try {
    const validatedData = setupActivateSchema.parse(req.body);
    const { token, /* ... other fields ... */ } = validatedData;

    // ... existing validation code ...

    // Create or update household
    if (household) {
      // Update existing household
      // ... existing update code ...
    } else {
      // Create new household
      household = await storage.createHousehold({...});
    }

    if (!household) {
      return res.status(500).json({ error: "Failed to create/update household" });
    }

    // ========================================
    // NEW: Mark QR code as activated (one-time use)
    // ========================================
    try {
      const orderItem = await storage.getOrderItemByActivationCode(token);
      
      if (orderItem && orderItem.item.activationStatus !== 'activated') {
        // Update item status to 'activated'
        await storage.updateOrderMagnetItemStatus(
          orderItem.item.id,
          'activated',
          household.email || 'unknown'
        );
        
        console.log(`ğŸ”’ Marked QR code as activated: ${token}`);
        
        // Create audit event
        await storage.createOrderMagnetAuditEvent({
          orderId: orderItem.order.id,
          itemId: orderItem.item.id,
          actor: 'customer',
          type: 'qr_activated',
          data: {
            activationCode: token,
            householdId: household.id,
            activatedBy: household.email,
            activatedAt: new Date().toISOString()
          }
        });
      }
    } catch (activationError) {
      console.error('Error marking QR as activated:', activationError);
      // Don't fail the activation if this fails - just log it
    }
    // ========================================

    // ... rest of existing code (climate zone, schedules, etc.) ...

    res.json({
      success: true,
      household: {
        id: household.id,
        token: household.magnetToken,
        zip: household.zip,
        homeType: household.homeType,
        climateZone,
      },
      // ... rest of response ...
    });
  } catch (error: any) {
    return handleError(error, 'setup/activate', res);
  }
});
```

### STEP 4B: Add Storage Function to Update Item Status

**File:** `server/storage.ts`

**Location:** Add after other storage functions

```typescript
/**
 * Update order magnet item activation status
 * Used to mark QR code as used (one-time use enforcement)
 */
export async function updateOrderMagnetItemStatus(
  itemId: string,
  status: 'inactive' | 'activated' | 'deactivated',
  activatedByEmail?: string
): Promise<void> {
  try {
    const { db } = await import('./db');
    const { orderMagnetItemsTable } = await import('../shared/schema');
    const { eq } = await import('drizzle-orm');
    
    console.log(`ğŸ”„ Updating item ${itemId} status to: ${status}`);
    
    const updateData: any = {
      activationStatus: status,
      updatedAt: new Date()
    };
    
    // Set activated timestamp and email if activating
    if (status === 'activated') {
      updateData.activatedAt = new Date();
      if (activatedByEmail) {
        updateData.activatedByEmail = activatedByEmail;
      }
    }
    
    await db
      .update(orderMagnetItemsTable)
      .set(updateData)
      .where(eq(orderMagnetItemsTable.id, itemId));
    
    console.log(`âœ… Successfully updated item ${itemId} to ${status}`);
    
  } catch (error) {
    console.error('Error updating order magnet item status:', error);
    throw error;
  }
}
```

---

## 8. COMPLETE FLOW DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Customer Purchases Magnet via Stripe                     â”‚
â”‚    â†“                                                         â”‚
â”‚ 2. Webhook Creates Order in PostgreSQL                      â”‚
â”‚    â†“                                                         â”‚
â”‚ 3. Generate QR Code with NEW_SITE_URL                       â”‚
â”‚    QR URL: https://upkeepqr.com/setup/OJnpwrlc8PsQ         â”‚
â”‚    Status: activationStatus = 'inactive'                    â”‚
â”‚    â†“                                                         â”‚
â”‚ 4. Send Welcome Email with Inline QR Code                   â”‚
â”‚    â†“                                                         â”‚
â”‚ 5. Customer Scans QR Code                                   â”‚
â”‚    â†“                                                         â”‚
â”‚ 6. Redirects to NEW SITE: /setup/OJnpwrlc8PsQ              â”‚
â”‚    â†“                                                         â”‚
â”‚ 7. Frontend Calls: GET /api/setup/:token/customer-data     â”‚
â”‚    â†“                                                         â”‚
â”‚ 8. Backend Checks:                                          â”‚
â”‚    - Token exists? âœ…                                        â”‚
â”‚    - Already activated? âŒ (first time)                      â”‚
â”‚    - Return customer data                                   â”‚
â”‚    â†“                                                         â”‚
â”‚ 9. Form Pre-fills with Customer Data (editable)             â”‚
â”‚    â†“                                                         â”‚
â”‚ 10. Customer Reviews/Edits and Submits                      â”‚
â”‚    â†“                                                         â”‚
â”‚ 11. POST /api/setup/activate                                â”‚
â”‚    â†“                                                         â”‚
â”‚ 12. Create Household Record                                 â”‚
â”‚    â†“                                                         â”‚
â”‚ 13. Mark QR Code as 'activated' âœ…                          â”‚
â”‚     Update: activationStatus = 'activated'                  â”‚
â”‚              activatedAt = NOW                              â”‚
â”‚              activatedByEmail = customer email              â”‚
â”‚    â†“                                                         â”‚
â”‚ 14. Return Success Response                                 â”‚
â”‚    â†“                                                         â”‚
â”‚ 15. IF SCANNED AGAIN:                                       â”‚
â”‚     - GET /api/setup/:token/customer-data                  â”‚
â”‚     - Backend sees activationStatus = 'activated'           â”‚
â”‚     - Returns 409 Conflict: "Already activated"            â”‚
â”‚     - Frontend shows ğŸ”’ message + disables form             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. TESTING CHECKLIST

### Test 1: First-Time Activation (Happy Path)

```bash
1. Complete Stripe purchase (test mode)
2. Receive welcome email
3. Scan QR code from email
4. Verify:
   [ ] Redirects to NEW site (/setup/OJnpwrlc8PsQ)
   [ ] Form loads successfully
   [ ] Customer data pre-fills:
       - Full name âœ…
       - Email âœ…
       - Phone âœ…
       - Address âœ…
       - City âœ…
       - State âœ…
       - Zip âœ…
   [ ] All fields are EDITABLE
   [ ] User can modify pre-filled data
5. Complete form (add home details)
6. Click "Complete Setup"
7. Verify:
   [ ] Success message shown
   [ ] Household record created in database
   [ ] Order item status = 'activated'
   [ ] activatedAt timestamp set
   [ ] activatedByEmail = customer email
```

### Test 2: Second-Time Activation (Already Used)

```bash
1. Using SAME QR code from Test 1
2. Scan QR code again
3. Verify:
   [ ] Redirects to /setup/OJnpwrlc8PsQ
   [ ] Page loads
   [ ] GET /api/setup/:token/customer-data returns 409
   [ ] Frontend shows "ğŸ”’ Already Activated" warning
   [ ] Form is DISABLED (grayed out)
   [ ] Submit button shows "ğŸ”’ Already Activated"
   [ ] Cannot submit form
   [ ] Message: "Each QR code can only be activated once"
```

### Test 3: Invalid Token

```bash
1. Manually navigate to /setup/INVALID_TOKEN
2. Verify:
   [ ] Page loads (doesn't crash)
   [ ] GET /api/setup/:token/customer-data returns 404
   [ ] No pre-fill data shown
   [ ] Form is EMPTY
   [ ] User can fill manually
   [ ] Submit works normally (creates household)
```

### Test 4: Two-Pack Purchase

```bash
1. Purchase 2-pack
2. Receive email with 2 QR codes
3. Scan QR Code #1:
   [ ] Pre-fills customer data
   [ ] Activation successful
   [ ] QR #1 marked as 'activated'
4. Scan QR Code #2:
   [ ] Pre-fills SAME customer data
   [ ] Activation successful
   [ ] QR #2 marked as 'activated'
5. Scan QR Code #1 again:
   [ ] Shows "Already activated" âœ…
6. Scan QR Code #2 again:
   [ ] Shows "Already activated" âœ…
```

### Test 5: 100-Pack Purchase

```bash
1. Purchase 100-pack
2. Receive email with preview
3. Download PDF
4. Test 3 random QR codes:
   [ ] All pre-fill customer data
   [ ] All activate successfully
   [ ] Each becomes 'activated' after use
   [ ] Re-scanning shows "Already activated"
```

---

## 10. DATABASE VERIFICATION

### Check Activation Status

**Query order_magnet_items table:**

```sql
-- Before activation
SELECT 
  activation_code,
  activation_status,  -- Should be 'inactive'
  activated_at,       -- Should be NULL
  activated_by_email, -- Should be NULL
  qr_url
FROM order_magnet_items
WHERE activation_code = 'OJnpwrlc8PsQ';

-- Result:
-- activation_code  | activation_status | activated_at | activated_by_email | qr_url
-- OJnpwrlc8PsQ    | inactive          | NULL         | NULL               | https://upkeepqr.com/setup/OJnpwrlc8PsQ
```

```sql
-- After activation
SELECT 
  activation_code,
  activation_status,  -- Should be 'activated'
  activated_at,       -- Should have timestamp
  activated_by_email, -- Should have customer email
  qr_url
FROM order_magnet_items
WHERE activation_code = 'OJnpwrlc8PsQ';

-- Result:
-- activation_code  | activation_status | activated_at              | activated_by_email         | qr_url
-- OJnpwrlc8PsQ    | activated         | 2025-11-11 10:30:00      | samuel@example.com         | https://upkeepqr.com/setup/OJnpwrlc8PsQ
```

### Check Household Created

```sql
SELECT 
  id,
  magnet_token,
  name,
  email,
  activated_at
FROM households
WHERE magnet_token = 'OJnpwrlc8PsQ';

-- Result:
-- id       | magnet_token  | name              | email                | activated_at
-- uuid-123 | OJnpwrlc8PsQ | Samuel Fapohunda  | samuel@example.com   | 2025-11-11 10:30:00
```

---

## 11. SECURITY CONSIDERATIONS

### One-Time Use Enforcement

```typescript
// Backend checks BEFORE returning customer data
if (item.activationStatus === 'activated') {
  return res.status(409).json({
    alreadyActivated: true,
    message: 'This QR code has already been activated'
  });
}
```

### Race Condition Protection

```sql
-- Use database transaction for activation
BEGIN;

-- Check status
SELECT activation_status FROM order_magnet_items 
WHERE activation_code = 'OJnpwrlc8PsQ' 
FOR UPDATE;  -- Lock row

-- If inactive, update to activated
UPDATE order_magnet_items 
SET activation_status = 'activated',
    activated_at = NOW(),
    activated_by_email = 'customer@email.com'
WHERE activation_code = 'OJnpwrlc8PsQ'
AND activation_status = 'inactive';  -- Only if still inactive

COMMIT;
```

### Token Validation

```typescript
// Validate activation code format
const activationCodeRegex = /^[A-Za-z0-9]{12}$/;
if (!activationCodeRegex.test(token)) {
  return res.status(400).json({ error: 'Invalid activation code format' });
}
```

---

## 12. ERROR HANDLING

### Scenario 1: Network Failure During Activation

```typescript
try {
  // Attempt to fetch customer data
  const response = await fetch(`/api/setup/${token}/customer-data`);
} catch (error) {
  // Show user-friendly message
  toast({
    variant: "destructive",
    title: "Connection Error",
    description: "Could not load your information. Please check your internet connection and try again."
  });
  
  // Allow manual form fill
  // Don't block user from proceeding
}
```

### Scenario 2: Database Error During Status Update

```typescript
try {
  await storage.updateOrderMagnetItemStatus(itemId, 'activated', email);
} catch (error) {
  console.error('Failed to mark QR as activated:', error);
  
  // Don't fail the activation - household still created
  // But send admin alert
  await sendAdminErrorAlert(
    'QR activation status update failed',
    error,
    itemId
  );
  
  // Continue with activation (user doesn't see error)
}
```

### Scenario 3: Customer Data Not Found

```typescript
if (!orderItem) {
  // Return empty data - allow manual fill
  return res.json({
    found: false,
    prefilled: false,
    data: {},
    message: 'Please fill in your information manually.'
  });
}
```

---

## 13. ENVIRONMENT VARIABLES SUMMARY

### Required .env Variables

```env
# Database (already configured)
DATABASE_URL=postgresql://...

# Site URLs
PUBLIC_BASE_URL=https://upkeepqr.com
NEW_SITE_URL=https://upkeepqr.com

# Or for development/testing
PUBLIC_BASE_URL=http://localhost:5000
NEW_SITE_URL=http://localhost:5000

# Stripe (already configured)
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Email (already configured)
SMTP_HOST=smtp.sendgrid.net
SMTP_USER=apikey
SMTP_PASS=SG.xxxxx
```

**Critical:** `NEW_SITE_URL` must point to the new site!

---

## 14. REPLIT AGENT PROMPT

**Copy and paste this into Replit Agent:**

```
Implement complete QR code activation flow with pre-population and one-time use.

CRITICAL REQUIREMENTS:

1. FIX QR CODE URL (NEW SITE):
   - File: server/routes.ts (webhook handler)
   - Find: const setupUrl = `${baseUrl}/setup/${activationCode}`;
   - Replace with: const setupUrl = `${process.env.NEW_SITE_URL || baseUrl}/setup/${activationCode}`;
   - Add .env variable: NEW_SITE_URL=https://upkeepqr.com

2. ADD CUSTOMER DATA LOOKUP ENDPOINT:
   - File: server/routes.ts
   - Add: GET /api/setup/:token/customer-data
   - Returns customer data if found and not activated
   - Returns 409 if already activated
   - Use getOrderItemByActivationCode() from storage

3. ADD STORAGE FUNCTION:
   - File: server/storage.ts
   - Add: getOrderItemByActivationCode(activationCode: string)
   - Returns {item, order} or null
   - Add: updateOrderMagnetItemStatus(itemId, status, email)
   - Updates activation_status, activated_at, activated_by_email

4. PRE-POPULATE SETUP FORM:
   - File: client/src/pages/Onboarding.tsx
   - Add state: customerDataLoaded, qrAlreadyActivated, customerDataError
   - Add useEffect to fetch customer data on mount
   - Pre-fill form fields with data.fullName, data.email, etc.
   - Show "Already Activated" warning if qrAlreadyActivated = true
   - Disable form if already activated

5. MARK QR AS ACTIVATED AFTER SUBMISSION:
   - File: server/routes.ts (POST /api/setup/activate)
   - After creating household, call updateOrderMagnetItemStatus()
   - Set status to 'activated'
   - Set activatedAt to NOW()
   - Set activatedByEmail to customer email
   - Create audit event

6. ONE-TIME USE ENFORCEMENT:
   - When fetching customer data, check item.activationStatus
   - If 'activated', return 409 with alreadyActivated: true
   - Frontend disables form and shows warning
   - Submit button shows "ğŸ”’ Already Activated"

IMPLEMENTATION ORDER:
1. Add NEW_SITE_URL to .env
2. Fix QR code URL generation in webhook
3. Add getOrderItemByActivationCode() to storage.ts
4. Add updateOrderMagnetItemStatus() to storage.ts
5. Add GET /api/setup/:token/customer-data endpoint
6. Update Onboarding.tsx with useEffect and pre-fill logic
7. Update POST /api/setup/activate to mark QR as used
8. Test complete flow

TESTING:
- Scan QR code â†’ verify redirects to NEW site
- Verify form pre-fills with customer data
- Verify fields are editable
- Complete activation â†’ verify household created
- Verify item.activationStatus = 'activated'
- Scan same QR again â†’ verify shows "Already activated"
- Verify form is disabled on second scan

DATA FLOW:
QR Scan â†’ GET /api/setup/:token/customer-data â†’ Pre-fill form â†’ Submit â†’ 
POST /api/setup/activate â†’ Create household â†’ Mark QR activated â†’ 
Second scan â†’ 409 Already activated â†’ Disable form

Follow specification exactly. This is CRITICAL for one-time use security.
```

---

## 15. SUCCESS CRITERIA

Implementation is complete when:

- [x] QR codes point to NEW_SITE_URL (not old site)
- [x] GET /api/setup/:token/customer-data endpoint exists
- [x] Endpoint returns customer data if token valid and not activated
- [x] Endpoint returns 409 if token already activated
- [x] Setup form pre-fills with customer data on page load
- [x] All pre-filled fields are editable
- [x] Form submission creates household record
- [x] After activation, item.activationStatus = 'activated'
- [x] activatedAt timestamp is set
- [x] activatedByEmail is set to customer email
- [x] Second scan shows "ğŸ”’ Already Activated" warning
- [x] Form is disabled on second scan
- [x] Submit button shows "ğŸ”’ Already Activated"
- [x] Cannot submit form twice with same QR code
- [x] Database audit events created
- [x] No console errors or warnings

---

## 16. FILE MODIFICATION SUMMARY

| File | Changes | Lines Added | Complexity |
|------|---------|-------------|------------|
| `.env` | Add NEW_SITE_URL | +1 | LOW |
| `server/routes.ts` | Fix QR URL, add endpoint, mark as used | +150 | MEDIUM |
| `server/storage.ts` | Add 2 functions | +80 | MEDIUM |
| `client/src/pages/Onboarding.tsx` | Add useEffect, pre-fill, disable | +120 | MEDIUM |
| **TOTAL** | **4 files** | **~350 lines** | **MEDIUM** |

---

## 17. ESTIMATED TIMELINE

- **Part 1:** Fix QR URL (30 minutes)
- **Part 2:** Add customer lookup endpoint (45 minutes)
- **Part 3:** Pre-populate form (60 minutes)
- **Part 4:** Mark as used (45 minutes)
- **Testing:** Complete flow (60 minutes)
- **Total:** 3-4 hours

---

**Status:** âœ… Ready for Replit Agent Implementation  
**Priority:** CRITICAL (Core Business Logic)  
**Last Updated:** 2025-11-11

---

## QUICK REFERENCE

**Core Issue:** QR codes link to old site, no pre-population, no one-time use

**Solution:**
1. Change QR URL to NEW_SITE_URL âœ…
2. Add customer data lookup endpoint âœ…
3. Pre-fill form with customer data âœ…
4. Mark QR as 'activated' after submission âœ…
5. Block second activation attempts âœ…

**Key Files:**
- `.env` - Add NEW_SITE_URL
- `server/routes.ts` - QR URL + endpoints + mark as used
- `server/storage.ts` - Lookup + update functions
- `client/src/pages/Onboarding.tsx` - Pre-fill + disable

**Testing:**
- Scan â†’ Pre-fills â†’ Submit â†’ Activated âœ…
- Scan again â†’ Shows error â†’ Disabled âŒ

**Ready to implement!** ğŸš€