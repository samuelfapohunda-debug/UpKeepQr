# Customer Dashboard Implementation Specification

## Project Overview
Build a comprehensive customer dashboard for home maintenance management with three primary tabs: Tasks, Appliances, and Household Details. Users access the dashboard via magic links and can manage maintenance tasks, track appliances, and view household information.

## Current Code Analysis

### Existing Components Ready for Use:
1. **Backend APIs** (`routes/customer.ts`, `routes/appliances.ts`, `routes/auth.ts`):
   - ✅ `/api/customer/household` - Returns household details
   - ✅ `/api/customer/tasks` - Returns tasks with summary stats
   - ✅ `/api/households/:householdId/appliances` - Full CRUD for appliances
   - ✅ `/api/auth/magic` - Magic link authentication flow
   - ✅ `/api/auth/session/verify` - Session verification
   - ⚠️ Need: PATCH endpoint for task completion

2. **Frontend Components**:
   - `CustomerDashboard.tsx` - Main dashboard component (needs enhancement)
   - `ApplianceManager.tsx` - Complete appliance management
   - `HouseholdDetails.tsx` - Household information display (needs creation)
   - `App.tsx` - Router includes `/my-home` route

3. **Authentication Flow**:
   - ✅ Magic links → session creation → dashboard redirect
   - ✅ Session validation middleware
   - ✅ Cookie-based session storage

## Implementation Requirements

### Phase 1: Core Dashboard Structure
#### 1.1 Create Type Definitions
**File:** `src/types/dashboard.ts`
```typescript
export type TaskStatus = 'completed' | 'pending' | 'overdue';
export type TaskPriority = 'low' | 'medium' | 'high';

export interface Task {
  id: number;
  taskName: string;
  description: string;
  category: string;
  priority: TaskPriority;
  status: TaskStatus;
  dueDate: string;
  frequencyMonths: number;
  completedAt?: string;
}

export interface Household {
  id: string;
  firstName: string;
  lastName: string;
  email: string;
  homeType: string;
  city: string;
  state: string;
  zip: string;
}

export interface TasksResponse {
  tasks: Task[];
  summary?: {
    total: number;
    completed: number;
    pending: number;
    overdue: number;
  };
}

export interface TaskStats {
  total: number;
  completed: number;
  pending: number;
  overdue: number;
}

export type DashboardTab = 'tasks' | 'appliances' | 'details';
```

#### 1.2 Create HouseholdDetails Component
**File:** `src/components/HouseholdDetails.tsx`
- Display household information in a clean card layout
- Show: name, email, home type, location
- Include edit button (initially toast notification for future implementation)
- Optional: Show appliance and task counts

#### 1.3 Create Tab Persistence Hook
**File:** `src/hooks/useTabState.ts`
```typescript
import { useState, useEffect } from 'react';

export function useTabState<T extends string>(
  key: string,
  defaultValue: T
): [T, (value: T) => void] {
  const [state, setState] = useState<T>(() => {
    try {
      const saved = localStorage.getItem(key);
      if (saved) return saved as T;
    } catch (error) {
      console.warn(`Error reading localStorage key "${key}":`, error);
    }
    return defaultValue;
  });

  useEffect(() => {
    try {
      localStorage.setItem(key, state);
    } catch (error) {
      console.warn(`Error saving to localStorage key "${key}":`, error);
    }
  }, [key, state]);

  return [state, setState];
}
```

### Phase 2: Update CustomerDashboard Component
#### 2.1 Import Dependencies
```typescript
import { useState, useEffect, useMemo, useCallback } from "react";
import { useLocation } from "wouter";
import { useQuery, useQueryClient, useMutation } from "@tanstack/react-query";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from "@/components/ui/alert-dialog";
import { API_BASE_URL } from "@/lib/api-config";
import { useToast } from "@/hooks/use-toast";
import { Home, CheckCircle2, Clock, AlertTriangle, Calendar, ListTodo, RefreshCw, Filter, Loader2, LogOut, CheckCircle, Wrench, Settings, User } from "lucide-react";
import HouseholdDetails from "@/components/HouseholdDetails";
import ApplianceManager from "@/components/ApplianceManager";
import type { Task, Household, TasksResponse, TaskStats, DashboardTab } from "@/types/dashboard";
import { useTabState } from "@/hooks/useTabState";
```

#### 2.2 Implement Helper Functions
```typescript
// Safe date formatting
const formatDate = (dateStr?: string): string => {
  if (!dateStr) return "Not scheduled";
  const date = new Date(dateStr);
  return isNaN(date.getTime())
    ? "Invalid date"
    : date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
      });
};

// Priority variant mapping
const getPriorityVariant = (priority: string): "destructive" | "secondary" | "outline" => {
  switch (priority?.toLowerCase()) {
    case "high": return "destructive";
    case "medium": return "secondary";
    default: return "outline";
  }
};

// Status color classes
const getStatusColor = (status: string): string => {
  switch (status?.toLowerCase()) {
    case "completed": return "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300";
    case "pending": return "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300";
    case "overdue": return "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300";
    default: return "bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300";
  }
};
```

#### 2.3 Implement State Management
```typescript
// Use tab persistence hook
const [activeTab, setActiveTab] = useTabState<DashboardTab>("customerDashboardTab", "tasks");

// Memoized derived data for performance
const stats = useMemo(() => {
  const total = tasks.length;
  const completed = tasks.filter(t => t.status === "completed").length;
  const pending = tasks.filter(t => t.status === "pending").length;
  const overdue = tasks.filter(t => t.status === "overdue").length;
  return { total, completed, pending, overdue };
}, [tasks]);

const categories = useMemo(() => {
  const categorySet = new Set(tasks.map(t => t.category));
  return ["all", ...Array.from(categorySet)];
}, [tasks]);

const filteredTasks = useMemo(() => {
  if (selectedCategory === "all") return tasks;
  return tasks.filter(t => t.category.toLowerCase() === selectedCategory.toLowerCase());
}, [tasks, selectedCategory]);
```

#### 2.4 Implement Task Completion Mutation
```typescript
const completeTaskMutation = useMutation({
  mutationFn: async (taskId: number) => {
    const response = await fetch(`${API_BASE_URL}/api/customer/tasks/${taskId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ status: 'completed' as const })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to complete task');
    }
    
    return response.json();
  },
  onSuccess: (updatedTask) => {
    toast({
      title: "Task Completed",
      description: `${updatedTask.taskName} has been marked as complete`,
    });
    
    // Optimistic cache update
    queryClient.setQueryData<TasksResponse>(['/api/customer/tasks'], (old) => {
      if (!old) return old;
      return {
        ...old,
        tasks: old.tasks.map(task => 
          task.id === updatedTask.id ? updatedTask : task
        )
      };
    });
    
    setShowCompleteDialog(false);
    setTaskToComplete(null);
  },
  onError: (error: Error) => {
    toast({
      title: "Error",
      description: error.message || "Failed to complete task",
      variant: "destructive",
    });
  },
  onSettled: () => {
    setCompletingTask(false);
  }
});
```

#### 2.5 Implement Tab Structure in JSX
```tsx
<Tabs value={activeTab} onValueChange={(value) => setActiveTab(value as DashboardTab)} className="w-full">
  <TabsList className="grid grid-cols-3 mb-6">
    <TabsTrigger value="tasks" data-testid="tab-tasks">
      <ListTodo className="h-4 w-4 mr-2" />
      Tasks
    </TabsTrigger>
    <TabsTrigger value="appliances" data-testid="tab-appliances">
      <Settings className="h-4 w-4 mr-2" />
      Appliances
    </TabsTrigger>
    <TabsTrigger value="details" data-testid="tab-details">
      <User className="h-4 w-4 mr-2" />
      Details
    </TabsTrigger>
  </TabsList>

  {/* Tasks Tab Content */}
  <TabsContent value="tasks" className="space-y-4">
    {/* Task filtering buttons and list */}
  </TabsContent>

  {/* Appliances Tab Content */}
  <TabsContent value="appliances">
    {household && (
      <ApplianceManager 
        householdId={household.id}
        onClose={() => {}} // No close action in tab context
      />
    )}
  </TabsContent>

  {/* Details Tab Content */}
  <TabsContent value="details">
    {household && (
      <HouseholdDetails 
        household={household}
        onEdit={() => {
          toast({
            title: "Edit Feature",
            description: "Household editing will be available soon.",
          });
        }}
      />
    )}
  </TabsContent>
</Tabs>
```

### Phase 3: Backend API Enhancement
#### 3.1 Add Task Completion Endpoint
**File:** `routes/customer.ts`
Add this route before `export default router`:

```typescript
router.patch('/tasks/:taskId', requireSessionAuth, async (req: SessionAuthRequest, res: Response) => {
  try {
    const householdId = req.sessionHouseholdId;
    const { taskId } = req.params;
    
    if (!householdId) {
      return res.status(401).json({ error: 'Session not authenticated' });
    }
    
    // Verify the task belongs to the household
    const [assignment] = await db
      .select()
      .from(householdTaskAssignmentsTable)
      .where(
        and(
          eq(householdTaskAssignmentsTable.id, parseInt(taskId)),
          eq(householdTaskAssignmentsTable.householdId, householdId)
        )
      )
      .limit(1);
    
    if (!assignment) {
      return res.status(404).json({ error: 'Task not found' });
    }
    
    // Prevent double-completion
    if (assignment.status === 'completed') {
      return res.status(400).json({ 
        error: 'Task already completed',
        details: `Task was completed on ${assignment.completedAt ? new Date(assignment.completedAt).toLocaleDateString() : 'a previous date'}`
      });
    }
    
    // Update the task status to completed
    const [updatedAssignment] = await db
      .update(householdTaskAssignmentsTable)
      .set({ 
        status: 'completed',
        completedAt: new Date(),
        updatedAt: new Date()
      })
      .where(eq(householdTaskAssignmentsTable.id, parseInt(taskId)))
      .returning();
    
    // Get the full task details
    const [task] = await db
      .select({
        id: householdTaskAssignmentsTable.id,
        taskName: homeMaintenanceTasksTable.taskName,
        description: homeMaintenanceTasksTable.description,
        category: homeMaintenanceTasksTable.category,
        priority: householdTaskAssignmentsTable.priority,
        status: householdTaskAssignmentsTable.status,
        dueDate: householdTaskAssignmentsTable.dueDate,
        frequencyMonths: homeMaintenanceTasksTable.frequencyMonths,
        completedAt: householdTaskAssignmentsTable.completedAt
      })
      .from(householdTaskAssignmentsTable)
      .innerJoin(homeMaintenanceTasksTable, eq(householdTaskAssignmentsTable.taskId, homeMaintenanceTasksTable.id))
      .where(eq(householdTaskAssignmentsTable.id, parseInt(taskId)))
      .limit(1);
    
    return res.json(task);
  } catch (error) {
    console.error('Error updating task:', error);
    return res.status(500).json({ error: 'Failed to update task' });
  }
});
```

#### 3.2 Update Schema Types (Optional)
**File:** `shared/schema.ts`
Add enum for task status:
```typescript
export const taskStatusEnum = pgEnum('task_status', ['pending', 'completed', 'overdue']);

export type TaskStatus = 'pending' | 'completed' | 'overdue';
```

### Phase 4: Update ApplianceManager for Tab Integration
#### 4.1 Remove Dialog Wrapper
- Remove the outer `<Dialog>` component since it's now in a tab
- Keep the inner `<Dialog>` for add/edit forms only
- Add comment: `// Dialog used only for add/edit appliance form`

#### 4.2 Update JSX Structure
```tsx
<div className="space-y-4">
  <div className="flex items-center justify-between gap-4">
    <div>
      <h2 className="text-2xl font-bold tracking-tight">Appliances</h2>
      <p className="text-muted-foreground">
        Manage and track all appliances in your home
      </p>
    </div>
    {warrantiesExpiringSoon > 0 && (
      <Badge variant="secondary" className="ml-2">
        <AlertTriangle className="h-3 w-3 mr-1" />
        {warrantiesExpiringSoon} warranty alert{warrantiesExpiringSoon > 1 ? 's' : ''}
      </Badge>
    )}
  </div>

  {/* Appliance grid and forms */}
</div>
```

### Phase 5: Testing Requirements
#### 5.1 Test Scenarios
1. **Authentication Flow**
   - Magic link → Dashboard redirect
   - Session persistence on refresh
   - Logout clears session

2. **Tab Navigation**
   - All three tabs render correctly
   - Tab state persists in localStorage
   - URL doesn't change on tab switch

3. **Tasks Tab**
   - Stats cards show correct numbers
   - Category filtering works
   - Complete task button shows dialog
   - Task status updates after completion
   - Prevents double-completion

4. **Appliances Tab**
   - ApplianceManager loads without Dialog wrapper
   - CRUD operations work
   - Warranty alerts display

5. **Details Tab**
   - Household information displays correctly
   - Edit button shows toast notification

#### 5.2 Test IDs to Implement
```tsx
// Tabs
data-testid="tab-tasks"
data-testid="tab-appliances"
data-testid="tab-details"

// Tasks
data-testid={`button-complete-${task.id}`}
data-testid="button-confirm-complete"
data-testid={`filter-${category}`}

// Appliances
data-testid="button-add-appliance"
data-testid={`button-edit-appliance-${appliance.id}`}
data-testid={`button-delete-appliance-${appliance.id}`}

// General
data-testid="button-refresh"
data-testid="button-logout"
data-testid="button-request-pro"
data-testid="button-edit-household"
```

### Phase 6: Performance Optimizations
#### 6.1 Implement useCallback for Event Handlers
```typescript
const handleRefresh = useCallback(() => {
  queryClient.invalidateQueries({ queryKey: ['/api/customer/household'] });
  queryClient.invalidateQueries({ queryKey: ['/api/customer/tasks'] });
  toast({
    title: "Refreshed",
    description: "Dashboard data has been refreshed",
  });
}, [queryClient, toast]);
```

#### 6.2 Implement useMemo for Derived Data
Already implemented in Phase 2.3

#### 6.3 Implement Optimistic Updates
Already implemented in task completion mutation

## File Structure After Implementation
```
src/
├── components/
│   ├── HouseholdDetails.tsx          # NEW
│   ├── ApplianceManager.tsx          # UPDATED
│   └── ... (existing components)
├── hooks/
│   └── useTabState.ts                # NEW
├── types/
│   └── dashboard.ts                  # NEW
├── pages/
│   └── CustomerDashboard.tsx         # UPDATED
├── routes/
│   └── customer.ts                   # UPDATED (add PATCH endpoint)
└── shared/
    └── schema.ts                     # UPDATED (optional - add enum)
```

## Success Criteria Checklist
- [ ] Three-tab dashboard loads at `/my-home`
- [ ] Tasks tab shows summary cards and filterable task list
- [ ] Tasks can be marked as complete via API
- [ ] Appliances tab shows ApplianceManager without Dialog wrapper
- [ ] Details tab shows household information
- [ ] Tab selection persists in localStorage
- [ ] Session verification works on page load
- [ ] All API calls are properly authenticated
- [ ] Mobile-responsive design maintained
- [ ] Performance optimizations implemented (useMemo, useCallback)
- [ ] Error handling for failed API calls
- [ ] Toast notifications for user actions

## Implementation Order
1. Create type definitions (`dashboard.ts`)
2. Create `HouseholdDetails` component
3. Create `useTabState` hook
4. Update `CustomerDashboard` with tab structure
5. Add PATCH endpoint to `customer.ts`
6. Update `ApplianceManager` for tab integration
7. Test all scenarios
8. Implement performance optimizations

## Notes for Replit Agent
- Use existing shadcn/ui components for consistency
- Follow TypeScript best practices
- Implement proper error boundaries
- Ensure all API calls include credentials
- Test on both desktop and mobile views
- Verify session authentication on all protected routes
- Add loading states for all async operations
- Implement proper form validation in ApplianceManager
- Use React Query for data fetching and caching
- Follow accessibility standards (ARIA labels, keyboard navigation)