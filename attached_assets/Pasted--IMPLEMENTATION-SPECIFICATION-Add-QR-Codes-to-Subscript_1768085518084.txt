# üéØ IMPLEMENTATION SPECIFICATION: Add QR Codes to Subscription Welcome Emails

## üìã OBJECTIVE
Modify the subscription checkout flow to generate and deliver QR codes to subscribers immediately upon purchase, matching the experience of one-time magnet purchases.

---

## üîç CURRENT STATE

### ‚úÖ What Works (One-Time Magnet Purchases)
- Webhook detects `session.mode === 'payment'`
- Generates activation codes and QR codes
- Stores in `order_magnet_items` table
- Sends welcome email with embedded QR codes
- Customer receives QR codes immediately

### ‚ùå What's Missing (Subscription Purchases)
- Webhook detects `session.mode === 'subscription'`
- **Does NOT generate QR codes**
- **Does NOT store activation codes**
- Sends welcome email **WITHOUT QR codes**
- Customer has no way to activate their subscription benefits

---

## üìä QR CODE ALLOCATION BY TIER

Based on pricing tiers in the system:

| Plan Name | Price | QR Codes to Generate |
|-----------|-------|---------------------|
| Homeowner Basic | $6.99/month | **1** QR code |
| Homeowner Plus | $12.99/month | **10** QR codes |
| Realtor/Agent | $39/month | **25** QR codes |
| Property Manager | $149/month | **200** QR codes |

**Important:** The plan name is stored in `session.metadata.plan` during checkout.

---

## üõ†Ô∏è IMPLEMENTATION STEPS

### STEP 1: Update Webhook Handler
**File:** `server/src/routes/webhook.ts`

**Location:** Inside the `if (session.mode === 'subscription')` block (around line 70)

**Current Code:**
```typescript
if (session.mode === 'subscription') {
  console.log('üì¶ Processing subscription checkout');
  
  const customerEmail = session.customer_details?.email || '';
  const customerName = session.customer_details?.name || '';
  const planName = session.metadata?.plan || 'UpKeepQR Subscription';
  const amountPaid = String((session.amount_total || 0) / 100);
  const subscriptionId = session.subscription || '';
  
  try {
    // Check for duplicate event
    // ... existing code ...
    
    // Send subscription emails (NO QR CODES)
    await Promise.all([
      sendSubscriptionWelcomeEmail(
        customerEmail,
        customerName,
        planName,
        amountPaid
      ),
      sendAdminSubscriptionNotification(...)
    ]);
    
    return res.json({ received: true, type: 'subscription', plan: planName });
  }
}
```

**New Code to Implement:**
```typescript
if (session.mode === 'subscription') {
  console.log('üì¶ Processing subscription checkout');
  
  const customerEmail = session.customer_details?.email || '';
  const customerName = session.customer_details?.name || '';
  const planName = session.metadata?.plan || 'UpKeepQR Subscription';
  const amountPaid = String((session.amount_total || 0) / 100);
  const subscriptionId = session.subscription || '';
  const baseUrl = process.env.PUBLIC_BASE_URL || 'https://upkeepqr.com';
  
  // üÜï STEP 1.1: Determine QR code quantity based on plan
  let qrCodeCount = 1; // Default for unknown plans
  
  if (planName.toLowerCase().includes('homeowner basic')) {
    qrCodeCount = 1;
  } else if (planName.toLowerCase().includes('homeowner plus')) {
    qrCodeCount = 10;
  } else if (planName.toLowerCase().includes('realtor') || planName.toLowerCase().includes('agent')) {
    qrCodeCount = 25;
  } else if (planName.toLowerCase().includes('property manager')) {
    qrCodeCount = 200;
  }
  
  console.log(`üéØ Generating ${qrCodeCount} QR codes for plan: ${planName}`);
  
  try {
    // üÜï STEP 1.2: Generate activation codes and QR codes
    const activationCodes = Array.from({ length: qrCodeCount }, () => nanoid(12));
    const qrCodes = await generateQRCodes(activationCodes, baseUrl);
    console.log(`‚úÖ Generated ${qrCodes.length} QR codes for subscription`);
    
    // üÜï STEP 1.3: Wrap in transaction to store QR codes
    const result = await db.transaction(async (tx) => {
      // Check for duplicate event (idempotency)
      try {
        await tx.insert(stripeEventsTable).values({
          eventId: event.id,
          eventType: event.type,
          sessionId: session.id,
        });
        console.log(`üÜï Processing new subscription event: ${event.id}`);
      } catch (error: any) {
        if (error.code === '23505') {
          console.log(`‚úÖ Subscription event ${event.id} already processed`);
          return { alreadyProcessed: true };
        }
        throw error;
      }
      
      // üÜï STEP 1.4: Create a "virtual order" for subscription QR codes
      const orderId = await generateOrderId();
      
      // @ts-expect-error - TypeScript LSP cache issue with Drizzle schema
      const [order] = await tx.insert(orderMagnetOrdersTable).values({
        orderId,
        customerName,
        customerEmail,
        customerPhone: session.customer_details?.phone || '',
        shipAddressLine1: session.customer_details?.address?.line1 || '',
        shipAddressLine2: session.customer_details?.address?.line2 || '',
        shipCity: session.customer_details?.address?.city || '',
        shipState: session.customer_details?.address?.state || '',
        shipZip: session.customer_details?.address?.postal_code || '',
        subtotal: amountPaid,
        total: amountPaid,
        paymentStatus: 'paid',
        paymentProvider: 'stripe',
        paymentRef: session.id,
        status: 'paid',
        orderType: 'subscription' // üÜï Mark as subscription order
      }).returning();
      
      console.log(`‚úÖ Created virtual order for subscription: ${orderId}`);
      
      // üÜï STEP 1.5: Create order items (one per QR code)
      for (let i = 0; i < activationCodes.length; i++) {
        const code = activationCodes[i];
        const qr = qrCodes[i];
        
        // @ts-expect-error - TypeScript LSP cache issue
        await tx.insert(orderMagnetItemsTable).values({
          orderId: order.id,
          sku: `subscription-${planName.toLowerCase().replace(/\s+/g, '-')}`,
          quantity: 1,
          unitPrice: String((session.amount_total || 0) / (100 * qrCodeCount)),
          activationCode: code,
          qrUrl: qr.qrUrl,
          activationStatus: 'inactive'
        });
      }
      
      console.log(`‚úÖ Created ${activationCodes.length} QR codes for subscription`);
      
      return { 
        alreadyProcessed: false, 
        orderId,
        qrCodes 
      };
    });
    
    // If already processed, return early
    if (result.alreadyProcessed) {
      return res.json({ received: true, alreadyProcessed: true, type: 'subscription' });
    }
    
    const { orderId, qrCodes: generatedQrCodes } = result;
    
    // üÜï STEP 1.6: Send emails with QR codes
    await Promise.all([
      // Customer welcome email WITH QR codes
      sendSubscriptionWelcomeEmail(
        customerEmail,
        customerName,
        planName,
        amountPaid,
        orderId,  // üÜï Pass orderId
        generatedQrCodes  // üÜï Pass QR codes
      ).then(result => {
        if (result) {
          console.log('‚úÖ Subscription welcome email with QR codes sent to:', customerEmail);
        } else {
          console.error('‚ùå Subscription welcome email failed');
        }
      }).catch(error => {
        console.error('‚ùå Failed to send subscription welcome email:', error);
      }),
      
      // Admin notification
      sendAdminSubscriptionNotification(
        customerEmail,
        customerName,
        planName,
        amountPaid,
        String(subscriptionId),
        qrCodeCount  // üÜï Include QR count
      ).then(result => {
        if (result) {
          console.log('‚úÖ Admin subscription notification sent');
        } else {
          console.error('‚ùå Admin subscription notification failed');
        }
      }).catch(error => {
        console.error('‚ùå Failed to send admin subscription notification:', error);
      })
    ]);
    
    console.log('‚úÖ Subscription checkout with QR codes processed successfully');
    return res.json({ 
      received: true, 
      type: 'subscription', 
      plan: planName,
      qrCodesGenerated: qrCodeCount,
      orderId 
    });
    
  } catch (error: any) {
    console.error('‚ùå Error processing subscription:', error?.message);
    await sendAdminErrorAlert(
      'Subscription Webhook Failed',
      error?.message || 'Unknown error',
      { sessionId: session.id, customerEmail, planName, qrCodeCount }
    );
    
    return res.status(500).json({ error: 'Failed to process subscription' });
  }
}
```

**Required Imports:** (Add to top of file if not present)
```typescript
import { nanoid } from "nanoid";
import { generateQRCodes } from "../../lib/qr.js";
import { generateOrderId } from "../../utils/orderIdGenerator.js";
import { orderMagnetOrdersTable, orderMagnetItemsTable } from "@shared/schema";
```

---

### STEP 2: Update Email Function Signature
**File:** `server/lib/email.ts`

**Function:** `sendSubscriptionWelcomeEmail`

**Current Signature:**
```typescript
export async function sendSubscriptionWelcomeEmail(
  customerEmail: string,
  customerName: string,
  planName: string,
  amountPaid: string
): Promise<boolean>
```

**New Signature:**
```typescript
export async function sendSubscriptionWelcomeEmail(
  customerEmail: string,
  customerName: string,
  planName: string,
  amountPaid: string,
  orderId?: string,  // üÜï Optional for backward compatibility
  qrCodes?: Array<{ code: string; qrUrl: string; setupUrl: string }>  // üÜï QR codes array
): Promise<boolean>
```

---

### STEP 3: Update Email Template
**File:** `server/lib/email.ts`

**Function:** `sendSubscriptionWelcomeEmail`

**Add after the existing content section (before closing tags):**

```typescript
// üÜï STEP 3.1: Add QR codes section if provided
let qrCodesHtml = '';
let qrCodesText = '';
let qrAttachments: any[] = [];

if (qrCodes && qrCodes.length > 0) {
  const baseUrl = process.env.PUBLIC_BASE_URL || 'https://upkeepqr.com';
  const downloadUrl = orderId ? `${baseUrl}/api/orders/${orderId}/qr-codes` : '#';
  
  // Prepare CID attachments for QR code images
  const itemsToAttach = qrCodes.length > 10 ? qrCodes.slice(0, 2) : qrCodes;
  
  qrAttachments = itemsToAttach.map((qr, index) => {
    if (!qr.qrUrl || !qr.qrUrl.includes('base64,')) {
      console.warn(`‚ö†Ô∏è Invalid QR code image format for item ${index}`);
      return null;
    }
    
    try {
      const base64Data = qr.qrUrl.split(',')[1];
      return {
        filename: `qr-code-${index + 1}.png`,
        content: base64Data,
        encoding: 'base64',
        type: 'image/png',
        content_id: `qr_code_${index}`,
        disposition: 'inline'
      };
    } catch (error) {
      console.error(`‚ùå Error processing QR code ${index}:`, error);
      return null;
    }
  }).filter(Boolean);
  
  // HTML section for QR codes
  const qrItemsHtml = itemsToAttach.map((qr, index) => `
    <div class="qr-item">
      <h4 style="margin: 0 0 10px 0; color: #166534;">
        ${qrCodes.length > 1 ? `QR Code #${index + 1}` : 'Your QR Code'}
      </h4>
      <img 
        src="cid:qr_code_${index}" 
        alt="QR Code ${index + 1}" 
        style="width: 200px; height: 200px; border: 2px solid #10b981; border-radius: 8px; margin-bottom: 15px;"
      />
      <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
        <strong style="color: #059669;">Activation Code:</strong><br>
        <code style="font-size: 16px; letter-spacing: 1px; color: #166534;">${qr.code}</code>
      </div>
      <a 
        href="${qr.setupUrl}" 
        style="display: inline-block; background: #10b981; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: 600; margin-bottom: 20px;"
      >
        üì± Activate This QR Code
      </a>
    </div>
  `).join('');
  
  // Show note if there are more QR codes than displayed
  const remainingCodesNote = qrCodes.length > 2 ? `
    <div style="background: #fef3c7; border: 1px solid #fbbf24; padding: 15px; border-radius: 6px; margin-top: 15px;">
      <strong>Plus ${qrCodes.length - 2} more QR codes!</strong><br/>
      <span style="font-size: 14px;">Download all your QR codes below.</span>
    </div>
  ` : '';
  
  qrCodesHtml = `
    <div style="margin: 30px 0; padding: 30px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
      <h3 style="margin-top: 0; color: #166534;">üéØ Your QR Codes Are Ready!</h3>
      <p>Scan or click to activate each QR code and start tracking your home maintenance:</p>
      
      <div style="margin: 20px 0;">
        ${qrItemsHtml}
        ${remainingCodesNote}
      </div>
      
      ${orderId ? `
        <div style="text-align: center; margin-top: 20px;">
          <a 
            href="${downloadUrl}" 
            style="display: inline-block; background: #166534; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; font-weight: 600;"
          >
            üì• Download All QR Codes (PDF)
          </a>
        </div>
      ` : ''}
      
      <div style="margin-top: 20px; padding: 15px; background: #e0f2fe; border-left: 4px solid #0284c7; border-radius: 4px;">
        <strong style="color: #075985;">üí° Quick Setup:</strong>
        <ol style="margin: 10px 0 0 0; padding-left: 20px; color: #0c4a6e;">
          <li>Scan each QR code with your phone camera</li>
          <li>Follow the setup wizard to register your home</li>
          <li>Attach QR magnets to your appliances</li>
          <li>Receive automated maintenance reminders</li>
        </ol>
      </div>
    </div>
  `;
  
  // Plain text version
  qrCodesText = `
  
YOUR QR CODES
==============

You have ${qrCodes.length} QR code${qrCodes.length > 1 ? 's' : ''} included in your subscription.

${qrCodes.map((qr, i) => `
QR Code #${i + 1}:
Activation Code: ${qr.code}
Setup Link: ${qr.setupUrl}
`).join('\n')}

${orderId ? `Download all QR codes: ${downloadUrl}` : ''}

Quick Setup:
1. Scan each QR code with your phone camera
2. Follow the setup wizard to register your home
3. Attach QR magnets to your appliances
4. Receive automated maintenance reminders
`;
}

// üÜï STEP 3.2: Insert QR codes section in the HTML template
// Find this section in the existing HTML and add qrCodesHtml after the plan details:
```

**Find this section in the existing HTML:**
```html
<div class="content">
  <p>Hi ${customerName || 'there'},</p>
  
  <p>Thank you for subscribing to UpKeepQR! Your <span class="plan-badge">${planName}</span> subscription is now active.</p>
  
  <div class="feature-list">
    <h3 style="margin-top: 0; color: #166534;">What's included:</h3>
    <!-- existing features list -->
  </div>
```

**Add QR codes section RIGHT AFTER the feature list:**
```html
  </div>
  
  ${qrCodesHtml}  <!-- üÜï INSERT HERE -->
  
  <div style="margin-top: 30px; padding-top: 30px; border-top: 1px solid #e5e7eb;">
    <!-- rest of email content -->
  </div>
```

**Update the text version too:**
```typescript
const text = `Welcome to UpKeepQR - ${planName} Subscription Activated

Hi ${customerName || 'there'},

Thank you for subscribing to UpKeepQR! Your ${planName} subscription is now active.

What's included:
- Personalized maintenance task scheduling
- Smart reminders via email and SMS
- Appliance tracking with warranty alerts
- Maintenance history and cost tracking
${qrCodesText}  <!-- üÜï INSERT HERE -->

Need help? Reply to this email or visit: https://upkeepqr.com/support

Best regards,
The UpKeepQR Team
`;
```

**Update the sendEmail call to include attachments:**
```typescript
return await sendEmail({
  to: customerEmail,
  subject,
  text,
  html,
  attachments: qrAttachments  // üÜï Add QR code attachments
});
```

---

### STEP 4: Update Admin Notification (Optional)
**File:** `server/lib/email.ts`

**Function:** `sendAdminSubscriptionNotification`

**Update signature to include QR count:**
```typescript
export async function sendAdminSubscriptionNotification(
  customerEmail: string,
  customerName: string,
  planName: string,
  amountPaid: string,
  subscriptionId: string,
  qrCodeCount?: number  // üÜï Optional QR count
): Promise<boolean>
```

**Add to admin email body:**
```html
<tr>
  <td><strong>QR Codes Generated:</strong></td>
  <td>${qrCodeCount || 'N/A'}</td>
</tr>
```

---

### STEP 5: Database Schema Verification
**File:** `shared/schema.ts`

**Verify the `order_magnet_orders` table supports subscription orders:**

Check if there's an `orderType` field. If not, you may need to add it:
```typescript
orderType: text("order_type").default("one-time"), // or "subscription"
```

**If this field doesn't exist**, the system will still work - you can identify subscription orders by checking if `sku` starts with `subscription-`.

---

## ‚úÖ TESTING CHECKLIST

After implementation, test the following:

### Test 1: Homeowner Basic Subscription ($6.99)
- [ ] Complete checkout with test card
- [ ] Verify 1 QR code generated
- [ ] Check webhook logs for success
- [ ] Verify email received with 1 QR code
- [ ] Verify QR code can be scanned
- [ ] Verify setup URL works: `/setup/{CODE}`

### Test 2: Homeowner Plus Subscription ($12.99)
- [ ] Complete checkout
- [ ] Verify 10 QR codes generated
- [ ] Email shows first 10 QR codes inline
- [ ] Download PDF button works

### Test 3: Realtor Subscription ($39)
- [ ] Complete checkout
- [ ] Verify 25 QR codes generated
- [ ] Email shows first 2 QR codes as preview
- [ ] Note shows "+ 23 more codes"
- [ ] Download button works

### Test 4: Property Manager Subscription ($149)
- [ ] Complete checkout
- [ ] Verify 200 QR codes generated
- [ ] Email shows preview of 2 codes
- [ ] Download PDF works

### Test 5: Database Verification
- [ ] Check `order_magnet_orders` table has new row
- [ ] Check `order_magnet_items` table has correct number of rows
- [ ] Verify `activationCode` is unique for each
- [ ] Verify `activationStatus` is 'inactive'

### Test 6: Idempotency
- [ ] Replay same webhook event
- [ ] Verify no duplicate QR codes created
- [ ] Verify no duplicate emails sent

### Test 7: Error Handling
- [ ] Test with invalid plan name
- [ ] Verify fallback to 1 QR code
- [ ] Admin error alert sent

---

## üö® CRITICAL REMINDERS

1. **Import statements**: Ensure all required imports are at the top of the file
2. **TypeScript errors**: Use `@ts-expect-error` for Drizzle schema issues (as shown in examples)
3. **Idempotency**: The `stripeEventsTable` insert handles duplicate webhook prevention
4. **Base64 attachments**: QR codes are embedded as CID attachments for email compatibility
5. **Plan name matching**: Use `.toLowerCase().includes()` for flexible plan name matching
6. **Test mode**: Test thoroughly in Stripe Test Mode before going live

---

## üìù DEPLOYMENT STEPS

1. **Make changes** to `server/src/routes/webhook.ts` and `server/lib/email.ts`
2. **Test locally** in Replit development environment
3. **Commit to Git**:
   ```bash
   git add server/src/routes/webhook.ts server/lib/email.ts
   git commit -m "feat: Add QR code generation to subscription welcome emails"
   git push origin main
   ```
4. **Deploy to Render** (automatic via Git push)
5. **Test on production** with Stripe Test Mode
6. **Monitor webhook logs** for first few subscription checkouts

---

## üÜò TROUBLESHOOTING

### Issue: QR codes not showing in email
**Check:**
- Webhook logs show `Generated X QR codes`
- `qrCodes` array is passed to email function
- Base64 data is valid
- CID attachments are created

### Issue: Wrong number of QR codes generated
**Check:**
- Plan name matching logic (case-insensitive)
- `session.metadata.plan` value from Stripe
- Console logs show correct `qrCodeCount`

### Issue: Database error on order creation
**Check:**
- UUID for order is being generated
- All required fields are provided
- Transaction is wrapping correctly

### Issue: Duplicate QR codes
**Check:**
- `stripeEventsTable` idempotency check is working
- Webhook endpoint not being hit multiple times
- Event ID is unique

---

## üìû SUPPORT

If you encounter issues during implementation:
1. Check Render logs: `https://dashboard.render.com ‚Üí upkeepqr-backend ‚Üí Logs`
2. Check Stripe webhook logs: `https://dashboard.stripe.com/webhooks`
3. Review the working one-time purchase flow for reference
4. Compare with existing `sendWelcomeEmailWithQR` function

---

## ‚úÖ COMPLETION CRITERIA

Implementation is complete when:
- [ ] All 4 subscription tiers generate correct number of QR codes
- [ ] QR codes appear in subscription welcome email
- [ ] QR codes are stored in database with correct status
- [ ] Setup URLs work and activate correctly
- [ ] No duplicate codes created on webhook replay
- [ ] Admin notification includes QR code count
- [ ] All tests pass
- [ ] Code is deployed to production
- [ ] First real subscription customer receives QR codes successfully

---

**END OF SPECIFICATION**

*Last Updated: January 10, 2026*
*Status: Ready for Implementation*