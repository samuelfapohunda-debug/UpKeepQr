# FIX: Contact Form 404 Error - Add Missing API Route

**Issue:** Contact form submission fails with 404 error  
**Route Missing:** `/api/contact`  
**Priority:** HIGH (customer-facing feature broken)

---

## DIAGNOSTIC SUMMARY

### Error Details:
```
POST https://[replit-url]/api/contact 404 (Not Found)
Error: Unexpected token '<', "<!DOCTYPE "... is not valid JSON
```

### Root Cause:
- `/api/contact` endpoint not implemented in backend
- Frontend making POST request to non-existent route
- Server returning HTML 404 page instead of JSON

### Verification:
```bash
grep -r "'/contact'" server/
# Result: No matches found
```

---

## IMPLEMENTATION SPECIFICATION

### File 1: Create Contact Route Handler

**Location:** `server/src/routes/contact.ts`

```typescript
import { Router } from 'express';
import sgMail from '@sendgrid/mail';

const router = Router();

// Initialize SendGrid (already configured in environment)
sgMail.setApiKey(process.env.SENDGRID_API_KEY!);

/**
 * POST /api/contact
 * Handle contact form submissions
 * 
 * Request Body:
 * {
 *   name: string (required)
 *   email: string (required)
 *   phone?: string (optional)
 *   subject: string (required)
 *   message: string (required)
 * }
 * 
 * Response:
 * Success: { success: true, message: string }
 * Error: { error: string }
 */
router.post('/contact', async (req, res) => {
  try {
    const { name, email, phone, subject, message } = req.body;
    
    // Validation
    if (!name || !email || !subject || !message) {
      return res.status(400).json({ 
        error: 'Name, email, subject, and message are required' 
      });
    }
    
    // Email validation (basic)
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return res.status(400).json({ 
        error: 'Invalid email address' 
      });
    }
    
    // Send email via SendGrid
    await sgMail.send({
      to: process.env.CONTACT_EMAIL || 'support@upkeepqr.com',
      from: process.env.EMAIL_FROM || 'noreply@upkeepqr.com',
      replyTo: email,
      subject: `Contact Form: ${subject}`,
      text: `
Contact Form Submission

Name: ${name}
Email: ${email}
Phone: ${phone || 'Not provided'}
Subject: ${subject}

Message:
${message}
      `,
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <h2 style="color: #333;">New Contact Form Submission</h2>
          <div style="background: #f5f5f5; padding: 20px; border-radius: 5px;">
            <p><strong>Name:</strong> ${name}</p>
            <p><strong>Email:</strong> <a href="mailto:${email}">${email}</a></p>
            <p><strong>Phone:</strong> ${phone || 'Not provided'}</p>
            <p><strong>Subject:</strong> ${subject}</p>
          </div>
          <div style="margin-top: 20px;">
            <h3 style="color: #333;">Message:</h3>
            <p style="white-space: pre-wrap;">${message}</p>
          </div>
        </div>
      `
    });
    
    // Log successful submission (for monitoring)
    console.log(`✅ Contact form submitted by ${name} (${email})`);
    
    // Success response
    res.json({ 
      success: true, 
      message: 'Thank you for contacting us! We will respond within 24 hours.' 
    });
    
  } catch (error) {
    // Log error for debugging
    console.error('❌ Contact form error:', error);
    
    // Return user-friendly error
    res.status(500).json({ 
      error: 'Failed to send message. Please try again or email us directly at support@upkeepqr.com' 
    });
  }
});

export default router;
```

---

### File 2: Register Contact Routes

**Location:** `server/index.ts`

**Find the section where routes are registered (after other route imports):**

```typescript
// Add this import at the top with other route imports
import contactRoutes from './src/routes/contact';

// Add this registration with other route registrations
// (Look for lines like: app.use('/api', setupRoutes);)
app.use('/api', contactRoutes);
console.log('✅ Contact routes registered at /api/contact');
```

**Expected location in file:**
```typescript
// ... other imports ...
import setupRoutes from './src/routes/setup';
import leadsRoutes from './src/routes/leads';
import contactRoutes from './src/routes/contact'; // ADD THIS

// ... middleware setup ...

// Routes registration
app.use('/api/setup', setupRoutes);
app.use('/api/leads', leadsRoutes);
app.use('/api', contactRoutes); // ADD THIS
console.log('✅ Setup routes registered at /api/setup');
console.log('✅ Leads routes registered at /api/leads');
console.log('✅ Contact routes registered at /api/contact'); // ADD THIS
```

---

### File 3: Update Environment Variables (if needed)

**Location:** `.env`

**Add these if not present:**
```bash
# Contact form configuration
CONTACT_EMAIL=support@upkeepqr.com
EMAIL_FROM=noreply@upkeepqr.com

# SendGrid (should already exist)
SENDGRID_API_KEY=SG.your_key_here
```

---

## TESTING REQUIREMENTS

### Manual Test Cases:

**Test 1: Valid Submission**
```bash
curl -X POST http://localhost:5000/api/contact \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "email": "test@example.com",
    "phone": "4044886739",
    "subject": "Test Subject",
    "message": "Test message"
  }'

# Expected: 200 OK
# Response: {"success": true, "message": "Thank you for contacting us!..."}
```

**Test 2: Missing Required Fields**
```bash
curl -X POST http://localhost:5000/api/contact \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "email": "test@example.com"
  }'

# Expected: 400 Bad Request
# Response: {"error": "Name, email, subject, and message are required"}
```

**Test 3: Invalid Email**
```bash
curl -X POST http://localhost:5000/api/contact \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "email": "invalid-email",
    "subject": "Test",
    "message": "Test"
  }'

# Expected: 400 Bad Request
# Response: {"error": "Invalid email address"}
```

**Test 4: Frontend Form Submission**
1. Navigate to Contact Us page
2. Fill out form:
   - Name: Samuel Fapohunda
   - Email: samuel.fapohunda@gmail.com
   - Phone: 4044886739
   - Subject: Test Subject
   - Message: Hello Again
3. Click "Send Message"
4. Expected: Success message appears
5. Expected: No red error toast
6. Check email inbox for submission

---

## VERIFICATION STEPS

After implementation:

1. **Start server:**
   ```bash
   npm run dev
   ```

2. **Check console output:**
   ```
   ✅ Contact routes registered at /api/contact
   ```

3. **Test endpoint exists:**
   ```bash
   curl -X POST http://localhost:5000/api/contact \
     -H "Content-Type: application/json" \
     -d '{"name":"Test","email":"test@test.com","subject":"Test","message":"Test"}'
   ```

4. **Verify in browser:**
   - Open Contact page
   - Submit form
   - Check Network tab: POST /api/contact should return 200
   - Check for success message (no red error)

5. **Check email delivery:**
   - Submit form
   - Check support@upkeepqr.com inbox
   - Email should arrive within 30 seconds

---

## ERROR HANDLING

### Potential Issues and Solutions:

**Issue 1: SendGrid API Key Invalid**
```
Error: Unauthorized
```
**Solution:** Verify SENDGRID_API_KEY in `.env`

**Issue 2: Email Delivery Fails**
```
Error: 403 Forbidden
```
**Solution:** Verify sender email is verified in SendGrid

**Issue 3: Route Still 404**
```
POST /api/contact 404
```
**Solution:** 
- Verify `contactRoutes` imported correctly
- Verify `app.use('/api', contactRoutes)` is present
- Restart server completely

**Issue 4: CORS Error**
```
Access to fetch blocked by CORS policy
```
**Solution:** Verify CORS middleware allows origin:
```typescript
app.use(cors({
  origin: ['http://localhost:5173', process.env.FRONTEND_URL],
  credentials: true
}));
```

---

## DEPENDENCIES

**Required packages (should already be installed):**
- `@sendgrid/mail` ✅ (already in use)
- `express` ✅
- `dotenv` ✅

**If SendGrid not installed:**
```bash
npm install @sendgrid/mail
```

---

## REPLIT AGENT IMPLEMENTATION COMMAND

```
Create a new contact form API endpoint:

1. Create file server/src/routes/contact.ts with a POST /contact route handler that:
   - Accepts JSON body with fields: name, email, phone (optional), subject, message
   - Validates required fields (name, email, subject, message)
   - Validates email format with regex
   - Sends email using SendGrid with the contact form data to support@upkeepqr.com
   - Returns JSON success response or error response
   - Logs successful submissions and errors

2. Import and register the contact routes in server/index.ts:
   - Add import: import contactRoutes from './src/routes/contact'
   - Add route registration: app.use('/api', contactRoutes)
   - Add console log: console.log('✅ Contact routes registered at /api/contact')

3. Test the endpoint with curl or by submitting the contact form on the frontend

Use the exact code provided in the specification file for implementation.
```

---

## SUCCESS CRITERIA

✅ **Implementation Complete When:**
- [ ] File `server/src/routes/contact.ts` exists
- [ ] Route registered in `server/index.ts`
- [ ] Server logs: "✅ Contact routes registered at /api/contact"
- [ ] `POST /api/contact` returns 200 (not 404)
- [ ] Contact form submission succeeds
- [ ] Email arrives at support@upkeepqr.com
- [ ] No console errors in browser
- [ ] No red error toast appears

---

## ESTIMATED TIME

**Implementation:** 5 minutes  
**Testing:** 5 minutes  
**Total:** 10 minutes

---

## RELATED FILES

**Files Modified:**
- `server/src/routes/contact.ts` (NEW)
- `server/index.ts` (MODIFIED - add import and registration)

**Files Referenced:**
- `client/src/pages/Contact.tsx` (already making POST to /api/contact)
- `.env` (verify SENDGRID_API_KEY exists)

---

## NOTES FOR REPLIT AGENT

- Use existing SendGrid configuration (already set up for other emails)
- Follow same pattern as other route files in `server/src/routes/`
- Maintain consistency with error handling style used in other routes
- Console log format should match existing logs (✅ emoji prefix)
- Response format matches existing API responses (JSON with success/error keys)

---

**Status:** Ready for implementation  
**Priority:** HIGH  
**Blocking:** Customer contact functionality