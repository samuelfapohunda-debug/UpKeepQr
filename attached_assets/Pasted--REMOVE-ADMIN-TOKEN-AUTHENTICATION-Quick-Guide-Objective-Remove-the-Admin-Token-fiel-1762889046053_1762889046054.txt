# üîß REMOVE ADMIN TOKEN AUTHENTICATION - Quick Guide

## üéØ Objective

Remove the "Admin Token" field from login and enforce **email/password authentication only**.

---

## ‚ö° ONE-COMMAND SOLUTION (Copy This)

Run this command in your Replit Shell:

```bash
bash /mnt/user-data/outputs/remove-admin-token-auth.sh
```

This will:
- ‚úÖ Comment out `ADMIN_API_TOKEN` in `.env`
- ‚úÖ Remove `authenticateProAdmin` function from auth middleware
- ‚úÖ Remove admin token login routes
- ‚úÖ Create backups of all modified files
- ‚úÖ Show you next steps

---

## üìã MANUAL STEPS (If Automated Script Fails)

### 1. Remove ADMIN_API_TOKEN from .env

```bash
# Open .env file
nano .env

# Find and comment out (or delete) this line:
# ADMIN_API_TOKEN=your-token-here

# Save and exit (Ctrl+X, Y, Enter)
```

### 2. Update server/middleware/auth.ts

Remove or comment out the `authenticateProAdmin` function:

```typescript
// Before (DELETE THIS):
export function authenticateProAdmin(req: Request, res: Response, next: NextFunction) {
  const token = req.headers['x-admin-token'] as string;
  
  if (!token || token !== process.env.ADMIN_API_TOKEN) {
    return res.status(403).json({ error: 'Invalid admin token' });
  }
  
  next();
}

// After: Function completely removed
// Only keep authenticateAdmin and authenticateAgent functions
```

### 3. Update server/routes.ts

Remove any routes using `authenticateProAdmin`:

```typescript
// Before (DELETE THIS):
app.post('/api/admin/login', authenticateProAdmin, (req, res) => {
  // Admin token login logic
});

// After: Route removed completely
// Only use the email/password login route:
app.post('/api/agent/login', async (req, res) => {
  // Email/password authentication
});
```

### 4. Remove Admin Token UI Component

If you have a page like `client/src/pages/AdminLogin.tsx` that shows an "Admin Token" field:

**Option A:** Delete the entire file (recommended)
```bash
rm client/src/pages/AdminLogin.tsx
```

**Option B:** Update it to use email/password (use the new Login.tsx from the spec)

### 5. Update App.tsx Routes

Remove any routes pointing to the old admin token login:

```typescript
// Before (DELETE THIS):
<Route path="/admin" component={AdminLogin} />

// After: Use the new protected route
<Route path="/admin">
  {() => (
    <ProtectedRoute>
      <Dashboard />
    </ProtectedRoute>
  )}
</Route>
```

---

## üß™ VERIFY CHANGES

After making changes, test:

### 1. Restart Application
```bash
# Stop server (Ctrl+C in terminal)
npm run dev
```

### 2. Test Email/Password Login
```bash
# Visit: http://localhost:5173/login
# Enter:
#   Email: samuel@upkeepqr.com
#   Password: UpKeep2025!Admin
# Should redirect to: /admin/requests
```

### 3. Verify Token Auth Removed
```bash
# Old admin token route should NOT work:
curl -X POST http://localhost:5000/api/admin/login \
  -H "x-admin-token: any-token" \
  -H "Content-Type: application/json"

# Should return 404 or 403 (route doesn't exist)
```

### 4. Verify Email/Password Works
```bash
# New email/password route SHOULD work:
curl -X POST http://localhost:5000/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"email":"samuel@upkeepqr.com","password":"UpKeep2025!Admin"}'

# Should return: {"success": true, "token": "..."}
```

---

## üîÑ ROLLBACK (If Something Breaks)

The automated script creates backups. To restore:

```bash
# Find backup directory (will be listed in script output)
ls -la /tmp/upkeepqr-backup-*

# Restore files (replace TIMESTAMP with actual value)
cp /tmp/upkeepqr-backup-TIMESTAMP/auth.ts.bak server/middleware/auth.ts
cp /tmp/upkeepqr-backup-TIMESTAMP/routes.ts.bak server/routes.ts
cp /tmp/upkeepqr-backup-TIMESTAMP/.env.bak .env

# Restart application
npm run dev
```

---

## üìö FILES AFFECTED

| File | Action | Reason |
|------|--------|--------|
| `.env` | Comment out ADMIN_API_TOKEN | No longer needed |
| `server/middleware/auth.ts` | Remove authenticateProAdmin | Token auth removed |
| `server/routes.ts` | Remove admin token routes | Use email/password only |
| `client/src/pages/AdminLogin.tsx` | Delete or update | Remove token field |
| `client/src/App.tsx` | Update routes | Use new protected routes |

---

## ‚úÖ EXPECTED OUTCOME

**Before:**
- Login page shows "Admin Token" field
- Authentication uses ADMIN_API_TOKEN from .env
- Route: `/admin` with token-based auth

**After:**
- Login page shows "Email" and "Password" fields
- Authentication uses JWT tokens from email/password login
- Route: `/login` ‚Üí validates ‚Üí redirects to `/admin/requests`
- Admin token completely removed from codebase

---

## üõ†Ô∏è TROUBLESHOOTING

### "Cannot find module" errors after removal
```bash
# Check if you removed too much
# Make sure authenticateAdmin and authenticateAgent functions still exist
# Only remove authenticateProAdmin
```

### Login still shows "Admin Token" field
```bash
# Update the UI component
# Replace with the new Login.tsx from SPEC-FRONTEND-AUTH-RBAC-FINAL.md
# Or delete the old component
```

### Backend returns 403 on /api/admin/* routes
```bash
# These routes need JWT authentication now
# Make sure request includes: Authorization: Bearer <token>
# Token comes from POST /api/agent/login response
```

---

## üîê NEW AUTHENTICATION FLOW

```
Old Flow (REMOVED):
User ‚Üí Enter Admin Token ‚Üí Backend checks ADMIN_API_TOKEN ‚Üí Access granted

New Flow (CURRENT):
User ‚Üí Enter Email + Password ‚Üí Backend validates in Firebase ‚Üí 
Returns JWT token ‚Üí Frontend stores token ‚Üí Token used for all API calls
```

---

## üìñ RELATED DOCUMENTATION

- **Auth Implementation:** SPEC-FRONTEND-AUTH-RBAC-FINAL.md
- **Admin Credentials:** ADMIN-CREDENTIALS-SETUP.md
- **Quick Commands:** QUICK-COMMANDS.md

---

## üéØ SUMMARY

**Run this ONE command:**
```bash
bash /mnt/user-data/outputs/remove-admin-token-auth.sh
```

**Then:**
1. Restart your app
2. Login with email/password at `/login`
3. Verify admin token is completely removed

‚úÖ **Email/password authentication is now the ONLY way to login!**