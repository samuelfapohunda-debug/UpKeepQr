# REPLIT AGENT SPECIFICATION: Inline QR Code Display in Welcome Emails

**Feature:** Display QR Code Images Inline in Welcome Emails  
**Priority:** HIGH (User Experience Enhancement)  
**Estimated Time:** 30 minutes  
**Complexity:** LOW  
**File to Modify:** `server/lib/email.ts`

---

## 1. OBJECTIVE

Modify the `sendWelcomeEmailWithQR()` function to display QR code images inline in the email body, so customers can scan directly from their inbox without clicking any links.

---

## 2. CURRENT STATE VS DESIRED STATE

### Current Implementation (Text Only):
```
Email shows:
- Activation code: PGXWEvfxXTrN
- Link to activation page
- NO QR code image visible
```

### Desired Implementation (Inline QR Image):
```
Email shows:
- QR code IMAGE (scannable directly from email)
- Activation code below QR
- Activation button below code
```

---

## 3. FILE TO MODIFY

**Location:** `server/lib/email.ts`

**Function:** `sendWelcomeEmailWithQR()`

**Lines to Change:** The `qrRows` variable generation (approximately lines 150-170)

---

## 4. EXACT CODE CHANGES

### STEP 1: Find This Section

Look for this code in `server/lib/email.ts`:

```typescript
// Generate QR code rows for email
const qrRows = items.map((item, index) => `
  <tr>
    <td style="padding: 20px; text-align: center; border-bottom: 1px solid #ddd;">
      <p><strong>Magnet #${index + 1}</strong></p>
      <!-- OLD: QR code not properly displayed -->
    </td>
  </tr>
`).join('');
```

### STEP 2: Replace With This Exact Code

```typescript
// Generate QR code rows for email with inline QR images
const qrRows = items.map((item, index) => `
  <tr>
    <td style="padding: 20px; text-align: center; border-bottom: 1px solid #ddd;">
      
      <!-- QR Code Number/Title -->
      <p style="font-size: 18px; font-weight: bold; color: #333333; margin-bottom: 15px;">
        ${quantity > 1 ? `QR Code #${index + 1}` : 'Your QR Code'}
      </p>
      
      <!-- QR CODE IMAGE - INLINE DISPLAY -->
      <img 
        src="${item.qrCodeImage}" 
        alt="QR Code ${index + 1}" 
        style="
          width: 250px; 
          height: 250px; 
          margin: 15px auto; 
          display: block; 
          border: 3px solid #A6E22E; 
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        " 
      />
      
      <!-- Activation Code Label -->
      <p style="font-size: 14px; color: #666666; margin: 15px 0 5px 0;">
        Activation Code:
      </p>
      
      <!-- Activation Code Value -->
      <p style="
        font-family: 'Courier New', Courier, monospace; 
        font-size: 16px; 
        font-weight: bold; 
        color: #333333; 
        background: #f5f5f5; 
        padding: 10px 20px; 
        border-radius: 4px; 
        display: inline-block;
        margin: 5px 0 20px 0;
        letter-spacing: 2px;
      ">
        ${item.activationCode}
      </p>
      
      <br/>
      
      <!-- Activation Button -->
      <a 
        href="${item.setupUrl}" 
        style="
          display: inline-block; 
          padding: 12px 24px; 
          background: #A6E22E; 
          color: white; 
          text-decoration: none; 
          border-radius: 6px; 
          margin-top: 15px; 
          font-weight: bold; 
          font-size: 14px;
          box-shadow: 0 2px 4px rgba(166, 226, 46, 0.3);
        "
      >
        üì± Activate This Magnet
      </a>
      
    </td>
  </tr>
`).join('');
```

---

## 5. VERIFICATION THAT DATA EXISTS

### Confirm `item.qrCodeImage` is Available

The `items` array passed to `sendWelcomeEmailWithQR()` should have this structure:

```typescript
items: Array<{
  activationCode: string;      // e.g., "PGXWEvfxXTrN"
  setupUrl: string;            // e.g., "https://upkeepqr.com/setup/PGXWEvfxXTrN"
  qrCodeImage: string;         // Base64 data URL: "data:image/png;base64,iVBORw0KG..."
}>
```

**The `qrCodeImage` is already generated in the webhook handler:**

```typescript
// In server/routes.ts webhook
const qrCodeBuffer = await QRCode.toBuffer(setupUrl, {...});
const qrDataUrl = `data:image/png;base64,${qrCodeBuffer.toString('base64')}`;

items.push({
  ...item,
  qrCodeImage: qrDataUrl,  // ‚Üê This is what we display in email
  setupUrl,
});
```

**No changes needed to webhook - it already creates the base64 image!**

---

## 6. UPDATE INSTRUCTIONS TEXT

Also update the instructions section in the same function:

### Find This:
```typescript
<div class="instructions">
  <h3>üì± How to Activate Your Magnet${quantity > 1 ? 's' : ''}:</h3>
  <ol>
    <li><strong>Scan the QR code</strong> with your phone camera</li>
    <li><strong>Complete the setup form</strong> (your info will be pre-filled)</li>
    <li><strong>Receive personalized maintenance reminders</strong> for your home</li>
  </ol>
  <p><em>Or click the "Activate" button below each QR code to get started right away!</em></p>
</div>
```

### Replace With:
```typescript
<div class="instructions">
  <h3>üì± How to Activate Your Magnet${quantity > 1 ? 's' : ''}:</h3>
  <ol>
    <li><strong>Scan the QR code below</strong> with your phone camera (QR code${quantity > 1 ? 's are' : ' is'} displayed in this email)</li>
    <li><strong>Or click the "Activate" button</strong> under each QR code</li>
    <li><strong>Complete the setup form</strong> (your info will be pre-filled)</li>
    <li><strong>Receive personalized maintenance reminders</strong> for your home</li>
  </ol>
  <p><em>Your QR code${quantity > 1 ? 's are' : ' is'} displayed below. You can also download a PDF with all your codes for printing.</em></p>
</div>
```

---

## 7. SPECIAL HANDLING FOR 100-PACK

For 100-pack orders, showing 100 QR codes inline would make the email too large.

### Add This Logic Before Generating QR Rows:

```typescript
// Special handling for large orders (100-pack)
let qrRows;
if (quantity > 10) {
  // Show only first 2 QR codes as preview for large orders
  const previewItems = items.slice(0, 2);
  
  qrRows = previewItems.map((item, index) => `
    <tr>
      <td style="padding: 20px; text-align: center; border-bottom: 1px solid #ddd;">
        <!-- Same QR display code as above -->
      </td>
    </tr>
  `).join('');
  
  // Add note about remaining QR codes
  qrRows += `
    <tr>
      <td style="padding: 20px; text-align: center; background: #f8f9fa;">
        <p style="font-size: 14px; color: #666; margin: 0;">
          <strong>Plus ${quantity - 2} more QR codes!</strong><br/>
          Download the complete PDF below to view all ${quantity} codes.
        </p>
      </td>
    </tr>
  `;
} else {
  // Show all QR codes inline for small orders (single, twopack)
  qrRows = items.map((item, index) => `
    <tr>
      <td style="padding: 20px; text-align: center; border-bottom: 1px solid #ddd;">
        <!-- QR display code as shown in STEP 2 above -->
      </td>
    </tr>
  `).join('');
}
```

---

## 8. COMPLETE FUNCTION STRUCTURE

The final `sendWelcomeEmailWithQR()` function should have this structure:

```typescript
export async function sendWelcomeEmailWithQR(params: {
  email: string;
  customerName: string;
  orderId: string;
  items: Array<{
    activationCode: string;
    setupUrl: string;
    qrCodeImage: string;  // ‚Üê Base64 data URL
  }>;
  quantity: number;
  sku: string;
}) {
  const { email, customerName, orderId, items, quantity, sku } = params;
  
  const baseUrl = process.env.PUBLIC_BASE_URL || 'http://localhost:5000';
  const downloadUrl = `${baseUrl}/api/orders/${orderId}/qr-codes`;

  const subject = `Welcome to UpKeepQR! Your QR Magnet${quantity > 1 ? 's Are' : ' Is'} Ready`;
  
  // Special handling for large orders
  let qrRows;
  if (quantity > 10) {
    // Show preview (first 2) for 100-pack
    // [Code from STEP 7 above]
  } else {
    // Show all QR codes inline for small orders
    qrRows = items.map((item, index) => `
      <!-- [Code from STEP 2 above] -->
    `).join('');
  }

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <!-- [Styles as shown in spec] -->
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>üéâ Welcome to UpKeepQR!</h1>
        </div>
        <div class="content">
          <p>Hi ${customerName},</p>
          
          <p>Your QR magnet${quantity > 1 ? 's are' : ' is'} ready!</p>
          
          <div class="instructions">
            <!-- [Updated instructions from STEP 6] -->
          </div>
          
          <div class="qr-container">
            <table class="qr-table">
              ${qrRows}
            </table>
          </div>
          
          <p style="text-align: center;">
            <a href="${downloadUrl}" class="button">üì• Download All QR Codes (PDF)</a>
          </p>
          
          <!-- [Rest of email content] -->
        </div>
      </div>
    </body>
    </html>
  `;

  await transporter.sendMail({
    from: '"UpKeepQR" <welcome@upkeepqr.com>',
    to: email,
    subject,
    html,
  });

  console.log(`‚úÖ Welcome email sent to ${email}`);
}
```

---

## 9. TESTING CHECKLIST

After implementing, test these scenarios:

### Test 1: Single Magnet
```bash
# Trigger test order for single magnet
# Check email received
# Verify:
[ ] QR code image displays
[ ] Image is 250x250 pixels
[ ] Green border (#A6E22E) visible
[ ] Activation code below QR
[ ] Button is clickable
[ ] Can scan QR from email
```

### Test 2: Two-Pack
```bash
# Trigger test order for twopack
# Check email received
# Verify:
[ ] Both QR codes display
[ ] QR Code #1 and QR Code #2 labeled
[ ] Each has unique activation code
[ ] Each has unique button
[ ] Both are scannable
```

### Test 3: 100-Pack
```bash
# Trigger test order for 100pack
# Check email received
# Verify:
[ ] First 2 QR codes shown as preview
[ ] Note says "Plus 98 more QR codes!"
[ ] PDF download link present
[ ] Email size reasonable (<100 KB)
```

### Test 4: Email Client Compatibility
```bash
# Open test email in:
[ ] Gmail web
[ ] Gmail mobile app
[ ] Apple Mail (iOS)
[ ] Outlook web
[ ] Outlook desktop

# Verify QR displays in all clients
```

### Test 5: QR Scanning
```bash
# From email on phone:
[ ] Open email
[ ] Point camera at QR code
[ ] QR scans successfully
[ ] Redirects to setup page
[ ] Customer data pre-fills
```

---

## 10. EXPECTED OUTPUT

### Email Rendering

**Header:**
```
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéâ Welcome to UpKeepQR!
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
```

**Body:**
```
Hi Samuel Fapohunda,

Your QR magnet is ready! Below is your unique QR code and activation link.

üì± How to Activate Your Magnet:
1. Scan the QR code below with your phone camera
2. Or click the "Activate" button
3. Complete the setup form (pre-filled)
4. Receive personalized maintenance reminders

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     Your QR Code             ‚ïë
‚ïë                              ‚ïë
‚ïë   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚ïë
‚ïë   ‚îÇ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚îÇ   ‚ïë
‚ïë   ‚îÇ ‚ñà‚ñà ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ ‚ñà‚ñÄ‚ñà ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ ‚ñà ‚îÇ   ‚ïë
‚ïë   ‚îÇ ‚ñà‚ñà ‚ñà   ‚ñà ‚ñà‚ñÄ‚ñÑ ‚ñà   ‚ñà ‚ñà ‚îÇ   ‚ïë
‚ïë   ‚îÇ ‚ñà‚ñà ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñà ‚ñà‚ñÄ‚ñà ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñà ‚ñà ‚îÇ   ‚ïë
‚ïë   ‚îÇ ‚ñà‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñÑ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñà ‚îÇ   ‚ïë
‚ïë   ‚îÇ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚îÇ   ‚ïë
‚ïë   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚ïë
‚ïë                              ‚ïë
‚ïë   Activation Code:           ‚ïë
‚ïë   PGXWEvfxXTrN              ‚ïë
‚ïë                              ‚ïë
‚ïë   [üì± Activate This Magnet]  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

[üì• Download All QR Codes (PDF)]
```

---

## 11. TROUBLESHOOTING

### Issue 1: QR Code Not Displaying

**Symptom:** Email shows broken image icon

**Cause:** `item.qrCodeImage` is undefined or not base64

**Solution:**
```typescript
// Check webhook generates base64 correctly
console.log('QR Code Image:', item.qrCodeImage?.slice(0, 50)); 
// Should start with: "data:image/png;base64,iVBORw0KG..."

// Verify it's being passed to email function
console.log('Items passed to email:', items.map(i => ({
  code: i.activationCode,
  hasImage: !!i.qrCodeImage,
  imageStart: i.qrCodeImage?.slice(0, 30)
})));
```

### Issue 2: Email Client Blocks Images

**Symptom:** Gmail shows "Images are not displayed"

**Cause:** Gmail blocks external images by default

**Solution:** Using base64 data URLs (not external URLs) bypasses this! ‚úÖ

**But if still blocked:**
```html
<!-- Add this alt text -->
<img 
  src="${item.qrCodeImage}" 
  alt="QR Code - Click 'Display Images' to view or use activation code below"
/>
```

### Issue 3: QR Code Too Large in Email

**Symptom:** Email takes long to load

**Cause:** QR code image is huge (>1 MB)

**Solution:**
```typescript
// Generate smaller QR code
const qrCodeBuffer = await QRCode.toBuffer(setupUrl, {
  type: 'png',
  width: 256,  // Reduced from 512
  margin: 1,   // Reduced from 2
  color: {
    dark: '#000000',
    light: '#FFFFFF'
  }
});
```

### Issue 4: QR Code Not Scannable

**Symptom:** Phone camera doesn't recognize QR

**Cause:** QR code compressed too much or too small

**Solution:**
```html
<!-- Ensure minimum display size -->
<img 
  src="${item.qrCodeImage}" 
  style="
    width: 250px;    /* Minimum 200px */
    height: 250px; 
    min-width: 200px;
    min-height: 200px;
  "
/>
```

---

## 12. PERFORMANCE CONSIDERATIONS

### Email Size Limits

- **Single magnet:** ~15 KB (well within limits)
- **Twopack:** ~25 KB (safe)
- **100-pack:** Show preview only, link to PDF

### Base64 Encoding Overhead

- PNG image: ~8 KB
- Base64 encoded: ~11 KB (+37% overhead)
- Acceptable for 1-2 QR codes per email

### Sending Time

- Adding inline images: +0.2 seconds per email
- Still fast enough (<2 seconds total)

---

## 13. ACCESSIBILITY

### Screen Reader Support

```html
<img 
  src="${item.qrCodeImage}" 
  alt="QR Code for activation. Scan with your phone camera or use activation code ${item.activationCode} below."
  role="img"
  aria-label="Scannable QR code for home maintenance magnet activation"
/>
```

### High Contrast Mode

```html
<!-- QR codes are black/white by design - already accessible -->
<img style="border: 3px solid #A6E22E;" />
<!-- Green border provides visual distinction -->
```

---

## 14. REPLIT AGENT PROMPT

**Copy and paste this into Replit Agent:**

```
Update the welcome email to display QR code images inline.

CRITICAL REQUIREMENTS:
1. Modify server/lib/email.ts function sendWelcomeEmailWithQR()
2. Update the qrRows variable generation to display QR code images inline
3. Use ${item.qrCodeImage} which contains base64 data URL (already generated in webhook)
4. Display QR code at 250x250 pixels with green border (#A6E22E)
5. Show activation code below QR in monospace font
6. Add "Activate This Magnet" button below code
7. For 100-pack orders: show first 2 QR codes as preview, then note about downloading PDF
8. Update instructions text to mention QR is displayed in email

EXACT CHANGES NEEDED:
- Find qrRows variable in sendWelcomeEmailWithQR function
- Replace with inline QR image display using <img src="${item.qrCodeImage}">
- Style: 250x250px, border 3px solid #A6E22E, border-radius 8px
- Add activation code below QR in gray box with monospace font
- Add green button linking to ${item.setupUrl}
- Handle large orders (>10 magnets) by showing preview only

QR CODE DISPLAY FORMAT:
<img 
  src="${item.qrCodeImage}" 
  alt="QR Code" 
  style="width: 250px; height: 250px; border: 3px solid #A6E22E; border-radius: 8px;"
/>

TESTING:
- Test single magnet order - verify QR displays
- Test twopack order - verify both QRs display
- Test 100pack order - verify preview shows first 2 only
- Open email in Gmail - verify QR is scannable
- Scan QR with phone - verify it works

NO OTHER FILES NEED CHANGES - webhook already generates qrCodeImage base64 data.

Follow specification exactly as documented in SPEC-STRIPE-PAYMENT-QR-WORKFLOW.md Section 4.3.
```

---

## 15. SUCCESS CRITERIA

Implementation is complete when:

- [x] QR code image displays inline in email body
- [x] QR code is 250x250 pixels with green border
- [x] Activation code shown below QR in monospace font
- [x] "Activate This Magnet" button present and working
- [x] Works for single, twopack, and 100pack orders
- [x] 100pack shows preview (2 QR codes) + PDF link
- [x] Email renders correctly in Gmail, Outlook, Apple Mail
- [x] QR code is scannable from phone email app
- [x] Instructions text updated to mention inline display
- [x] No console errors or warnings
- [x] Email sends successfully with QR images

---

## 16. ESTIMATED IMPLEMENTATION TIME

- **Code changes:** 15 minutes
- **Testing:** 10 minutes
- **Debugging:** 5 minutes
- **Total:** 30 minutes

**Complexity:** LOW (simple HTML/CSS changes)

---

**Status:** ‚úÖ Ready for Replit Agent Implementation  
**Priority:** HIGH (UX Improvement)  
**Last Updated:** 2025-11-11

---

## QUICK REFERENCE

**File:** `server/lib/email.ts`  
**Function:** `sendWelcomeEmailWithQR()`  
**Change:** Update `qrRows` variable to display inline images  
**Key Data:** `item.qrCodeImage` (base64 data URL, already generated)  
**Display Size:** 250x250 pixels  
**Border:** 3px solid #A6E22E  
**Testing:** Send test email, verify QR displays and scans  

**Ready to implement!** üöÄ