# Diagnostic Checklist: Welcome Email with QR Codes Not Sending

## Current Known Facts ✅

1. ✅ Payment Confirmation email IS working
2. ✅ Stripe webhook IS receiving events
3. ✅ SendGrid API key IS configured
4. ❌ Welcome email with QR codes NOT being sent

## Step-by-Step Diagnosis

### Step 1: Check Render Logs After Test Purchase

**Action:** Make a test purchase, then immediately check:
https://dashboard.render.com/web/srv-d4jtmm49c44c73eioqc0/logs

**Look for these specific log messages:**

```
# Webhook received
✅ "Stripe webhook received: checkout.session.completed"
✅ "Processing checkout session: cs_test_..."

# Order creation
✅ "Order created successfully" or similar

# Email attempts - THIS IS THE CRITICAL PART
Look for ANY of these:
- "Attempting to send welcome email"
- "sendWelcomeEmailWithQR called"
- "Generating QR codes"
- "QR code generated"
- "Sending email with attachments"
- "Welcome email sent"

# Errors - what we're looking for
❌ "Error generating QR code"
❌ "Failed to send welcome email"
❌ "SendGrid error"
❌ Any stack traces related to email
```

**What this tells us:**

| What you see in logs | What it means |
|---------------------|---------------|
| No mention of welcome email at all | Function is not being called |
| "Attempting to send..." but no success | Function is failing silently |
| "Error generating QR code" | QR code generation is broken |
| "SendGrid error" followed by error details | SendGrid is rejecting the email |
| Nothing after webhook received | Webhook handler is crashing early |

---

### Step 2: Check Stripe Webhook Logs

**Action:** Go to Stripe Dashboard
1. Navigate to: **Developers > Webhooks**
2. Click on your webhook endpoint: `https://upkeepqr.com/api/webhook/stripe`
3. Look at recent events

**What to check:**

```
✅ Event appears in webhook logs
✅ Status shows "Succeeded" (200 response)
❌ Status shows "Failed" (4xx or 5xx)
```

**If webhook shows "Failed":**
- Your webhook endpoint is returning an error
- The welcome email code might be throwing an exception that crashes the webhook handler

**If webhook shows "Succeeded":**
- Webhook completed without errors
- Welcome email might be silently failing and returning false
- Or welcome email function might not be called at all

---

### Step 3: Examine Your Code

**Please share or check these files:**

1. **Stripe Webhook Handler**
   - File: `server/src/routes/webhook.ts` or `server/routes/stripe.ts` or similar
   - Look for: Where `checkout.session.completed` is handled
   
   **Questions:**
   - Is `sendWelcomeEmailWithQR()` actually being called?
   - Is it wrapped in try-catch that might be swallowing errors?
   - Is there a condition that prevents it from being called?

2. **Email Sending Function**
   - File: `server/lib/mail.ts` or `server/utils/email.ts` or similar
   - Look for: `sendWelcomeEmailWithQR` function
   
   **Questions:**
   - Does this function exist?
   - What does it return (boolean, promise, void)?
   - Are errors being logged or silently caught?

3. **QR Code Generation**
   - Check: Is there a separate QR code generation function?
   
   **Questions:**
   - What library is being used? (qrcode, qr-image, etc.)
   - Is QR generation synchronous or async?
   - Are errors being caught and logged?

---

### Step 4: Check SendGrid Dashboard

**Action:** Go to SendGrid Dashboard
1. Navigate to: **Activity**
2. Filter by recipient email used in test purchase
3. Check time range: Last 24 hours

**What to look for:**

```
✅ "Payment Confirmed" email appears - shows SendGrid is working
❌ "Welcome to UpKeepQR" email missing - confirms issue
```

**Additional check:**
- Look at **Suppressions** > **Blocks**
- Look at **Suppressions** > **Bounces**
- Look at **Suppressions** > **Spam Reports**

**If blocked:**
- SendGrid might have auto-blocked emails with attachments
- Need to verify sender domain

---

### Step 5: Verify Database State

**Action:** Check if QR codes are being created in database

**Run this query in your production database:**

```sql
-- Check if order was created
SELECT id, customer_email, status, created_at 
FROM magnet_orders 
ORDER BY created_at DESC 
LIMIT 5;

-- Check if QR codes were generated
SELECT id, order_id, registration_code, qr_code_url, created_at
FROM qr_codes 
ORDER BY created_at DESC 
LIMIT 10;
```

**What this tells us:**

| Result | Meaning |
|--------|---------|
| Order exists, QR codes exist | Order processing worked, issue is only with email |
| Order exists, NO QR codes | QR code creation is failing |
| No order at all | Webhook handler failed before creating order |

---

## Diagnostic Decision Tree

Based on what you find:

### Scenario A: Welcome email function is NEVER called
**Evidence:** No logs mentioning welcome email at all
**Likely cause:** Webhook handler doesn't call the function
**Fix:** Add function call to webhook handler

### Scenario B: Welcome email function is called but fails silently
**Evidence:** Logs show "Attempting to send..." but no success/error
**Likely cause:** Function has a try-catch that swallows errors
**Fix:** Add proper error logging

### Scenario C: QR code generation fails
**Evidence:** Logs show error during QR code generation
**Likely cause:** 
- Missing qrcode npm package
- Async/await issue
- Invalid data being passed
**Fix:** Fix QR code generation code

### Scenario D: SendGrid rejects the email
**Evidence:** SendGrid API error in logs
**Likely cause:**
- Attachment too large
- Invalid base64 encoding
- Missing required fields
**Fix:** Fix email formatting/attachments

### Scenario E: QR codes not created in database
**Evidence:** Database query shows no QR codes
**Likely cause:** QR code creation logic failing before email
**Fix:** Fix database insertion logic

---

## Next Steps

**Please provide:**

1. **Render logs** from after a test purchase (copy the relevant section)

2. **Your webhook handler code** - specifically the part that handles `checkout.session.completed`

3. **Your welcome email function** - the actual implementation

4. **Database check results** - do QR codes exist in the database?

**With this information, I can provide a PRECISE fix for your exact issue, rather than guessing!**

---

## Quick Self-Diagnosis Commands

Run these in your Replit terminal to check:

```bash
# 1. Check if qrcode package is installed
npm list qrcode

# Expected: qrcode@1.5.x or similar
# If not found: npm install qrcode

# 2. Check if mail.ts exists and has the function
grep -r "sendWelcomeEmailWithQR" server/

# Expected: Should show file path and function definition

# 3. Check recent git commits
git log --oneline -10

# See if there are any commits related to email or QR codes

# 4. Check environment variables (careful - don't share output)
echo $SENDGRID_API_KEY | head -c 10

# Expected: Should show "SG.xxxxx" or similar
# If empty: SendGrid not configured
```

---

## Most Likely Issues (Ranked by Probability)

Based on "Payment Confirmation works but Welcome Email doesn't":

1. **70% - Function not being called at all** ⭐ MOST LIKELY
   - Webhook handler has conditional logic that skips it
   - Function call commented out or removed
   - Wrong event type being handled

2. **20% - QR code generation failing**
   - Missing npm package
   - Async/await bug
   - Invalid URL format

3. **5% - SendGrid rejecting email**
   - Attachment issues
   - Rate limiting

4. **5% - Database issue**
   - QR codes not being created
   - Missing foreign keys

**Let's verify which one it actually is before implementing a fix!**